<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="stylesheet" href="style.css">

    <meta name="robots" content="noindex, nofollow"> 

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>章鱼喷墨机</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>





<!-- === /zindex-patch === -->
</head>

<body>
<div class="phone-screen">
	<!-- 在 <div class="phone-screen"> 之后添加 -->
<div id="global-notification-banner" class="notification-banner">
    <img id="notification-avatar" src="" alt="avatar">
    <div id="notification-text"></div>
    <button id="notification-close-btn">&times;</button>
</div>
  <!-- START: 改造主屏幕以支持翻页 -->
<div id="home-container" class="screen active">
    <div class="home-page-wrapper">
        <!-- 这是原来的主页，现在是第一页 -->
        <div id="home-screen" class="home-page active"></div>
        <!-- 这是新增的第二页 -->
        <div id="home-screen-2" class="home-page"></div>
    </div>
    <div class="home-page-indicator">
        <span class="dot active" data-index="0"></span>
        <span class="dot" data-index="1"></span>
    </div>
</div>
<!-- END: 改造主屏幕 -->
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-container">‹</button>
            <div class="title-container">
                <h1 class="title">聊天</h1>
            </div>
            <div class="action-btn-group">
        <button class="action-btn" id="import-card-btn" title="导入角色卡">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;">
            <path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" />
        </svg>
    </button>
        <button class="action-btn" id="create-group-btn">群聊</button>
        <button class="action-btn" id="add-chat-btn">+</button>
    </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
  <!-- ▼▼▼ 用这个全新的header替换掉旧的header ▼▼▼ -->
<header class="app-header" id="chat-room-header-default">
    <button class="back-btn" data-target="chat-list-screen">‹</button>
    <div class="title-container">
        <h1 class="title" id="chat-room-title">...</h1>
        <div class="subtitle" id="chat-room-subtitle">
            <div class="online-indicator"></div>
            <span id="chat-room-status-text">在线</span>
        </div>
    </div>
    
    <!-- 新增的截图选择操作栏 (保持不变) -->
    <div id="screenshot-select-bar" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); padding: 10px 20px; z-index: 100; justify-content: space-between; align-items: center; color: white;">
        <button id="cancel-screenshot-select" class="btn btn-neutral btn-small">取消</button>
        <span id="screenshot-select-count">已选择 0 条</span>
        <button id="confirm-screenshot-select" class="btn btn-primary btn-small">生成截图</button>
    </div>

    <!-- 修正后的右侧按钮组 -->
    <div class="action-btn-group">
        <button class="action-btn" id="ai-trajectory-btn">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px; color:var(--primary-color);">
                <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path>
            </svg>
        </button>
        <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="设置"></button>
    </div>
</header>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">取消</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">选择消息</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        
        <div class="chat-input-wrapper">
        	<!-- 找到 <div class="chat-input-wrapper"> 在其内部最前面添加 -->
<div id="quote-reply-bar" style="padding: 8px 12px; background-color: rgba(240, 240, 240, 0.9); border-top: 1px solid #eee; display: none; align-items: center; gap: 8px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);">
    <div id="quoted-message-preview" style="flex-grow: 1; font-size: 13px; color: #666; border-left: 3px solid var(--primary-color); padding-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
    <button id="cancel-quote-reply-btn" style="background: none; border: none; font-size: 20px; color: #888; cursor: pointer; padding: 0 5px;">&times;</button>
</div>
          
<div id="sticker-bar">
    <button class="sticker-bar-btn" id="rollback-btn" title="撤回并重写">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12.5,8C9.85,8 7.45,9 5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22 10.54,10.5 12.5,10.5C16.04,10.5 19.05,12.81 20.1,16L22.47,15.22C21.08,11.03 17.15,8 12.5,8Z"></path>
        </svg>
    </button><!-- ... 紧跟在 id="rollback-btn" 的 </button> 之后 ... -->
<button class="sticker-bar-btn" id="continue-writing-btn" title="续写">
    <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M6,10A2,2 0 0,1 8,12A2,2 0 0,1 6,14A2,2 0 0,1 4,12A2,2 0 0,1 6,10M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M18,10A2,2 0 0,1 20,12A2,2 0 0,1 18,14A2,2 0 0,1 16,12A2,2 0 0,1 18,10Z"></path>
    </svg>
</button>
<!-- ... 后面是 id="sticker-toggle-btn" ... -->
    <button class="sticker-bar-btn" id="sticker-toggle-btn">
        <svg viewBox="0 0 24 24">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path>
        </svg>
    </button>
    <button class="sticker-bar-btn" id="photo-video-btn">
        <svg viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="image-recognition-btn">
        <svg viewBox="0 0 24 24"><path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="voice-message-btn">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="voice-call-btn">
        <svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="wallet-btn">
        <svg viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="gift-btn">
        <svg viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="diary-btn" style="display: none;">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M14 17H7V15H14V17M17 13H7V11H17V13M17 9H7V7H17V9Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="time-skip-btn">
        <svg viewBox="0 0 24 24"><path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="file-btn">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="location-btn">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12C20,15.08 18.05,17.78 15.42,19.23L12,14.5L8.58,19.23C5.95,17.78 4,15.08 4,12A8,8 0 0,1 12,4M12,6.5A5.5,5.5 0 0,0 6.5,12A5.5,5.5 0 0,0 12,17.5A5.5,5.5 0 0,0 17.5,12A5.5,5.5 0 0,0 12,6.5Z"></path></svg>
    </button>
    <button class="sticker-bar-btn" id="token-stats-btn" title="Token 统计" onclick="openTokenStatsModal()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M19,19H5V5H19V19Z M7,10H9V17H7V10M11,7H13V17H11V7M15,13H17V17H15V13Z"></path></svg>
    </button>
</div>
    <!-- ▼▼▼ 将新的微信输入栏粘贴到这里 ▼▼▼ -->
<div class="message-input-area" id="wechat-input-area" style="display: none;">
    <button id="plus-btn" class="icon-btn" style="background-color: transparent; color: #555;">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 28px; height: 28px;"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path></svg>
    </button>
    <input type="text" id="wechat-message-input" placeholder="输入消息...">
    <div class="wechat-send-btn-group" style="display: flex; gap: 8px;">
        <button id="wechat-send-message-btn" class="icon-btn send-btn">➤</button>
        <button id="wechat-get-reply-btn" class="icon-btn">
            <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"></path></svg>
        </button>
    </div>
</div>
<!-- ▲▲▲ 粘贴结束 ▲▲▲ -->  
	<!-- “+”号展开的功能面板 -->
    <div id="function-panel" class="function-panel">
        <div class="function-grid">
            <div class="function-item" data-action="sticker"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path></svg></div><span>表情</span></div>
            <div class="function-item" data-action="photo-video"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"></path></svg></div><span>照片</span></div>
            <div class="function-item" data-action="image-recognition"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z"></path></svg></div><span>识图</span></div>
            <div class="function-item" data-action="voice-message"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path></svg></div><span>语音</span></div>
            <div class="function-item" data-action="voice-call"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"></path></svg></div><span>通话</span></div>
            <div class="function-item" data-action="wallet"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z"></path></svg></div><span>钱包</span></div>
            <div class="function-item" data-action="gift"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z"></path></svg></div><span>礼物</span></div>
            <div class="function-item" data-action="time-skip"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path></svg></div><span>跳时</span></div>
            <div class="function-item" data-action="file"><div class="icon-bg"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path></svg></div><span>文件</span></div>
            <div class="function-item" data-action="location"><div class="icon-bg"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12C20,15.08 18.05,17.78 15.42,19.23L12,14.5L8.58,19.23C5.95,17.78 4,15.08 4,12A8,8 0 0,1 12,4M12,6.5A5.5,5.5 0 0,0 6.5,12A5.5,5.5 0 0,0 12,17.5A5.5,5.5 0 0,0 17.5,12A5.5,5.5 0 0,0 12,6.5Z"></path></svg></div><span>位置</span></div>
            <div class="function-item" data-action="rollback"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M12.5,8C9.85,8 7.45,9 5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22 10.54,10.5 12.5,10.5C16.04,10.5 19.05,12.81 20.1,16L22.47,15.22C21.08,11.03 17.15,8 12.5,8Z"></path></svg></div><span>重Roll</span></div>
    <div class="function-item" data-action="continue-writing"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M6,10A2,2 0 0,1 8,12A2,2 0 0,1 6,14A2,2 0 0,1 4,12A2,2 0 0,1 6,10M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M18,10A2,2 0 0,1 20,12A2,2 0 0,1 18,14A2,2 0 0,1 16,12A2,2 0 0,1 18,10Z"></path></svg></div><span>续写</span></div>
    <div class="function-item" data-action="diary"><div class="icon-bg"><svg viewBox="0 0 24 24"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M14 17H7V15H14V17M17 13H7V11H17V13M17 9H7V7H17V9Z"></path></svg></div><span>日记</span></div>
    <div class="function-item" data-action="token-stats"><div class="icon-bg"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M9,17H7V10H9V17M13,17H11V7H13V17M17,17H15V13H17V17Z"/></svg></div><span id="token-stats-label">Token</span></div>
</div>
</div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->
        
<!-- ▲▲▲ 粘贴到这里结束 ▲▲▲ -->
            <div class="message-input-area" id="message-input-default">
                <input type="text" id="message-input" placeholder="输入消息...">
                <button id="send-message-btn" class="icon-btn send-btn">➤</button>
                <button id="get-reply-btn" class="icon-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"/>
                    </svg>
                </button>
            </div>
            <div class="message-input-area" id="message-edit-bar" style="display: none;">
                <input type="text" id="message-edit-input">
                <button id="save-edit-btn" class="icon-btn send-btn">✓</button>
                <button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button>
            </div>
        </div>
        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
            </button>
        </div>
        <!-- ===== 重构后的表情包选择弹窗 ===== -->
        <div id="sticker-modal">
            <!-- 顶部：分组标签栏 + 更多菜单按钮 -->
            <div class="sticker-modal-header">
                <div class="sticker-tabs-container">
                    <div class="sticker-tabs" id="sticker-tabs">
                        <!-- 动态渲染：[全部] [未分类] [猫猫组]... -->
                    </div>
                </div>
                <button class="sticker-menu-btn" id="sticker-menu-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 中间：表情包网格 -->
            <div class="sticker-grid" id="sticker-grid-container"></div>
            
            <!-- 🆕 多选管理底部操作栏 -->
            <div class="sticker-selection-bar" id="sticker-selection-bar">
                <!-- 🆕 全选按钮 -->
                <button class="selection-bar-btn btn-select-all" id="select-all-stickers-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M0.41,13.41L6,19L7.41,17.58L1.83,12M22.24,5.58L11.66,16.17L7.5,12L6.07,13.41L11.66,19L23.66,7M18,7L16.59,5.58L10.24,11.93L11.66,13.34L18,7Z"/>
                    </svg>
                    <span>全选</span>
                </button>
                <button class="selection-bar-btn" id="move-selected-stickers-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10.93,11.47L13.45,14L10.93,16.53L12.34,17.94L16.28,14L12.34,10.06L10.93,11.47M7.66,17.94L9.07,16.53L6.55,14L9.07,11.47L7.66,10.06L3.72,14L7.66,17.94Z"/>
                    </svg>
                    <span>移动</span>
                </button>
                <div class="selection-info">
                    <span id="selected-sticker-count">已选 0 项</span>
                </div>
                <button class="selection-bar-btn btn-danger" id="delete-selected-stickers-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                    </svg>
                    <span>删除</span>
                </button>
                <button class="selection-bar-btn" id="exit-selection-mode-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                    </svg>
                    <span>退出</span>
                </button>
            </div>
        </div>
        
        <!-- 底部菜单 Action Sheet -->
        <div class="sticker-menu-action-sheet" id="sticker-menu-action-sheet">
            <div class="action-sheet-backdrop" id="sticker-menu-backdrop"></div>
            <div class="action-sheet-content">
                <button class="action-sheet-item" id="menu-multi-select-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,5V19H5V5H19M10,17L6,13L7.41,11.58L10,14.17L16.59,7.58L18,9"/>
                    </svg>
                    <span>多选管理</span>
                </button>
                <button class="action-sheet-item" id="menu-batch-import-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"></path>
                    </svg>
                    <span>批量导入</span>
                </button>
                <button class="action-sheet-item" id="menu-add-new-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path>
                    </svg>
                    <span>添加新表情</span>
                </button>
                <button class="action-sheet-item action-sheet-cancel" id="menu-cancel-btn">
                    <span>取消</span>
                </button>
            </div>
        </div>
        <!-- ===== 重构结束 ===== -->
    </div>
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-container">‹</button>
            <div class="title-container">
                <h1 class="title">世界书</h1>
            </div>
      <div class="action-btn-group">
      	<button class="action-btn" id="import-world-book-btn">✦</button> 
    <button class="action-btn" id="add-world-book-category-btn">分类</button>
    <button class="action-btn" id="add-world-book-btn">+</button>
</div>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>你的世界一片混沌...</p>
                <p>点击右上角的“+”创造第一个设定吧！</p>
            </div>
        </main>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
    <label for="world-book-category-select">所属分类</label>
    <select id="world-book-category-select">
        <!-- Options will be populated by JS -->
    </select>
</div>
<!-- ▼▼▼ START: 新增功能字段 ▼▼▼ -->
        <div class="form-group">
            <label for="world-book-keywords">触发关键词 (逗号分隔)</label>
            <input type="text" id="world-book-keywords" placeholder="例如: 戒指,婚戒,ring">
        </div>
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 0;">
                <label for="world-book-always-active" style="margin-bottom: 0;">始终启用</label>
                <input type="checkbox" id="world-book-always-active" style="width: auto; height: 20px;">
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 0;">
                <label for="world-book-case-sensitive" style="margin-bottom: 0;">区分大小写</label>
                <input type="checkbox" id="world-book-case-sensitive" style="width: auto; height: 20px;">
            </div>
        </div>
        <!-- ▲▲▲ END: 新增功能字段 ▲▲▲ -->
                <div class="form-group">
                    <label for="world-book-content">条目内容</label>
                    <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                </div>
                <div class="form-group">
                    <label>注入位置</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                        <label><input type="radio" name="world-book-position" value="after"> 后</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存条目</button>
            </form>
        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
<!-- 在 id="api-settings-screen" 的 </div> 之后添加以下代码 -->
<!-- START: 新增渲染器应用界面 -->
<div id="renderer-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container">
            <h1 class="title">渲染器</h1>
        </div>
        <div class="action-btn-group">
        	<div class="action-btn-group">
    <button class="action-btn" id="import-renderer-rules-btn">导入</button> <!-- 新增的按钮 -->
            <button class="action-btn" id="add-renderer-category-btn">分类</button>
            <button class="action-btn" id="add-renderer-rule-btn">+</button>
        </div>
    </header>
    <main class="content renderer-layout">
        <div class="renderer-sidebar">
            <ul class="list-container" id="renderer-category-list"></ul>
        </div>
        <div class="renderer-main">
            <ul class="list-container" id="renderer-rule-list"></ul>
            <div class="placeholder-text" id="no-renderer-rules-placeholder" style="display: none;">
                <p>该分类下没有规则</p>
                <p>点击右上角的“+”创建一条吧！</p>
            </div>
        </div>
    </main>
</div>
<!-- END: 新增渲染器应用界面 -->
<div id="diary-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="chat-room-screen">‹</button>
        <div class="title-container">
            <h1 class="title">日记</h1>
        </div>
        <button class="action-btn" id="generate-diary-manually-btn">
             <svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px;">
                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
            </svg>
        </button>
    </header>
    <main class="content">
        <ul class="list-container" id="diary-list-container"></ul>
        <div class="placeholder-text" id="no-diaries-placeholder" style="display: none;">
            <p>还没有日记哦~</p>
            <p>多聊聊天，让Ta记录下你们的故事吧！</p>
        </div>
    </main>
</div>
    <div id="wallpaper-screen" class="screen"></div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>


<!-- 自定义组件编辑器弹窗 -->
<div id="customize-widget-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>自定义组件</h3>
        <form id="customize-widget-form">
            <input type="hidden" id="editing-widget-id">
            <div class="form-group">
                <label for="widget-text-input">显示文字</label>
                <input type="text" id="widget-text-input" placeholder="输入要显示的文字" required>
            </div>
            <div class="form-group">
                <label for="widget-image-url-input">图片 URL</label>
                <input type="url" id="widget-image-url-input" placeholder="粘贴图片URL">
            </div>
            <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
            <input type="file" id="widget-image-upload" accept="image/*" style="display:none;">
            <label for="widget-image-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
            <button type="submit" class="btn btn-primary">保存</button>
        </form>
    </div>
</div>
<div id="new-post-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>发布新帖</h3>
        <form id="new-post-form">
            <div class="form-group">
                <label for="post-title-input">帖子标题</label>
                <input type="text" id="post-title-input" required>
            </div>
            <div class="form-group">
                <label for="post-content-input">帖子内容</label>
                <textarea id="post-content-input" rows="6" required></textarea>
            </div>
            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between; margin-top: 15px;">
                <label for="post-anonymous-checkbox" style="margin-bottom: 0;">匿名发布</label>
                <input type="checkbox" id="post-anonymous-checkbox" style="width: auto; height: 20px;">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">发布</button>
        </form>
    </div>
</div>
    <div id="toast-notification" class="toast"></div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                                                                       placeholder="角色的真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                                                                                placeholder="你对Ta的称呼" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                                                                         placeholder="你希望Ta如何称呼你" required>
                </div>
                <button type="submit" class="btn btn-primary">创建</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">添加新表情</h3>
            <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                <div id="sticker-preview"><span>预览</span></div>
                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                                                                                         placeholder="如：开心" required>
                </div>
                <!-- 🆕 新增：分组名称输入框（带建议列表） -->
                <div class="form-group">
                    <label for="sticker-group-input">分组名称（选填）</label>
                    <input type="text" 
                           id="sticker-group-input" 
                           list="sticker-group-suggestions"
                           placeholder="如：猫猫组（留空则为"未分类"）"
                           autocomplete="off">
                    <datalist id="sticker-group-suggestions">
                        <!-- 动态渲染已有分组 -->
                    </datalist>
                </div>
                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"
                                                                                             id="sticker-url-input"
                                                                                             placeholder="粘贴图片URL">
                </div>
                <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p><input type="file"
                                                                                             id="sticker-file-upload"
                                                                                             accept="image/*"
                                                                                             style="display:none;"><label
                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    
    <!-- 🆕 移动表情到指定分组的弹窗 -->
    <div id="move-stickers-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>移动到分组</h3>
            <div class="form-group">
                <label for="move-stickers-target-group">目标分组</label>
                <input type="text" 
                       id="move-stickers-target-group" 
                       list="move-stickers-group-suggestions"
                       placeholder="输入或选择分组名称"
                       autocomplete="off">
                <datalist id="move-stickers-group-suggestions">
                    <!-- 动态渲染已有分组 -->
                </datalist>
                <p style="font-size: 12px; color: #888; margin-top: 8px;">
                    💡 提示：留空表示移动到"未分类"
                </p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-neutral" id="cancel-move-stickers-btn" style="flex: 1;">取消</button>
                <button class="btn btn-primary" id="confirm-move-stickers-btn" style="flex: 1;">确认移动</button>
            </div>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
        </div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发送语音消息</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">输入语音文字</label>
                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    预计时长: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享照片/视频</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">输入描述</label>
                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>转账</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">金额 (元)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">备注</label>
                    <input type="text" id="transfer-remark-input" placeholder="（选填）">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
        <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>送出礼物</h3>
            <form id="send-gift-form">
                <!-- ▼▼▼ 新增的价格输入框 ▼▼▼ -->
                <div class="form-group">
                    <label for="gift-amount-input">礼物价格 (元)</label>
                    <input type="number" id="gift-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <!-- ▲▲▲ 新增结束 ▲▲▲ -->
                <div class="form-group">
                    <label for="gift-description-input">礼物描述</label>
                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>记录今天发生的事</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Send File Modal -->
<div id="send-file-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>发送文件</h3>
        <form id="send-file-form">
            <div class="form-group">
                <label for="file-name-input">文件名</label>
                <input type="text" id="file-name-input" placeholder="例如：会议纪要.txt" required>
            </div>
            <div class="form-group">
                <label for="file-content-input">文件内容</label>
                <textarea id="file-content-input" placeholder="在此输入或粘贴文件内容..." required rows="6"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">发送</button>
        </form>
    </div>
</div>
<!-- NEW: Display File Modal -->
<div id="display-file-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="display-file-name" style="word-wrap: break-word;">文件名</h3>
        <div class="form-group" style="max-height: 60vh; overflow-y: auto; background-color: #f5f5f5; padding: 10px; border-radius: 8px;">
            <pre id="display-file-content" style="white-space: pre-wrap; word-wrap: break-word; font-size: 14px; color: #333;"></pre>
        </div>
        <button id="close-file-display-btn" class="btn btn-primary" style="margin-top: 20px;">关闭</button>
    </div>
</div>
<!-- NEW: Send Location Modal -->
<div id="send-location-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>发送位置</h3>
        <form id="send-location-form">
            <div class="form-group">
                <label for="location-main-input">主要位置</label>
                <input type="text" id="location-main-input" placeholder="例如：市中心购物广场" required>
            </div>
            <div class="form-group">
                <label for="location-detail-input">详细位置</label>
                <textarea id="location-detail-input" placeholder="例如：xx省xx市xx区人民路123号" required rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">发送</button>
        </form>
    </div>
</div>
<!-- NEW: Display Location Modal -->
<div id="display-location-modal" class="modal-overlay">
    <div class="modal-window" style="padding: 0; overflow: hidden;">
        <div id="display-location-map" style="width: 100%; height: 200px; background-size: cover; background-position: center;"></div>
        <div style="padding: 20px;">
            <h3 id="display-location-main" style="margin-top: 0; color: #333;"></h3>
            <p id="display-location-detail" style="color: #666; margin-bottom: 20px;"></p>
            <button id="close-location-display-btn" class="btn btn-primary">关闭</button>
        </div>
    </div>
</div>
<!-- NEW: Voice Call Modal -->
<div id="voice-call-overlay">
    <!-- Common Info -->
    <img src="" alt="Avatar" class="call-avatar-large" id="call-avatar">
    <h2 class="call-name" id="call-name">...</h2>
    <p class="call-status" id="call-status">正在呼叫...</p>

    <!-- Ringing/Incoming View -->
    <div id="ringing-view">
        <div class="call-button-group" id="incoming-buttons" style="display: none;">
            <button class="call-button decline" id="decline-call-btn">
                <div class="icon-wrapper"><svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 9,10.4 9,12S10.4,15 12,15 15,13.6 15,12 13.6,9 12,9M12,17.25C9.24,17.25 6.75,15.17 6.75,12.5C6.75,11.05 7.42,9.73 8.5,8.81L15.19,15.5C14.27,16.58 12.95,17.25 12,17.25M17.25,12C17.25,14.76 15.17,17.25 12.5,17.25C11.05,17.25 9.73,16.58 8.81,15.5L15.5,8.81C16.58,9.73 17.25,11.05 17.25,12M4.44,3L3,4.44L8.06,9.5C7.36,10.23 6.84,11.08 6.5,12H4.13C4.5,14.75 6.13,17.13 8.5,18.5V22H15.5V18.5C16.92,17.81 18.1,16.81 18.91,15.56L20.56,17.22L21.94,15.84L4.44,3Z" /></svg></div>
                <span>拒接</span>
            </button>
            <button class="call-button accept" id="accept-call-btn">
                <div class="icon-wrapper"><svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg></div>
                <span>接听</span>
            </button>
        </div>
        <div class="call-button-group" id="outgoing-buttons" style="display: none;">
            <button class="call-button decline" id="cancel-call-btn">
                 <div class="icon-wrapper"><svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 9,10.4 9,12S10.4,15 12,15 15,13.6 15,12 13.6,9 12,9M12,17.25C9.24,17.25 6.75,15.17 6.75,12.5C6.75,11.05 7.42,9.73 8.5,8.81L15.19,15.5C14.27,16.58 12.95,17.25 12,17.25M17.25,12C17.25,14.76 15.17,17.25 12.5,17.25C11.05,17.25 9.73,16.58 8.81,15.5L15.5,8.81C16.58,9.73 17.25,11.05 17.25,12M4.44,3L3,4.44L8.06,9.5C7.36,10.23 6.84,11.08 6.5,12H4.13C4.5,14.75 6.13,17.13 8.5,18.5V22H15.5V18.5C16.92,17.81 18.1,16.81 18.91,15.56L20.56,17.22L21.94,15.84L4.44,3Z" /></svg></div>
                <span>取消</span>
            </button>
        </div>
    </div>

    <!-- Active Call View -->
    <!-- 在 id="voice-call-overlay" 内部 -->
<div id="active-call-view">
    <!-- 新增：固定的顶部信息面板 -->
    <div id="active-call-header">
        <img src="" alt="Avatar" class="call-avatar-large" id="active-call-header-avatar">
        <h2 class="call-name" id="active-call-header-name">...</h2>
        <p class="call-status" id="active-call-header-status">通话中</p>
    </div>
    
    <div id="call-transcript-area"></div>
    
        <div class="call-button-group" id="hangup-button-container">
         <button class="call-button decline" id="hangup-call-btn">
            <div class="icon-wrapper"><svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 9,10.4 9,12S10.4,15 12,15 15,13.6 15,12 13.6,9 12,9M12,17.25C9.24,17.25 6.75,15.17 6.75,12.5C6.75,11.05 7.42,9.73 8.5,8.81L15.19,15.5C14.27,16.58 12.95,17.25 12,17.25M17.25,12C17.25,14.76 15.17,17.25 12.5,17.25C11.05,17.25 9.73,16.58 8.81,15.5L15.5,8.81C16.58,9.73 17.25,11.05 17.25,12M4.44,3L3,4.44L8.06,9.5C7.36,10.23 6.84,11.08 6.5,12H4.13C4.5,14.75 6.13,17.13 8.5,18.5V22H15.5V18.5C16.92,17.81 18.1,16.81 18.91,15.56L20.56,17.22L21.94,15.84L4.44,3Z" /></svg></div>
            <span>挂断</span>
        </button>
    </div>
    <div id="call-input-area">
        <input type="text" id="call-input" placeholder="输入文字...">
        <button id="send-call-message-btn">➤</button>
    </div>
  </div>
</div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">选择收件人</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                             <div class="avatar-setting">
    <div class="avatar-container-setting" id="char-avatar-container-setting">
        <img src="" alt="角色头像" id="setting-char-avatar-preview" class="avatar-preview">
        <!-- 头像框将动态添加在这里 -->
    </div>
    <button type="button" class="btn btn-small btn-primary avatar-frame-btn" data-target="private-ai">🌟</button>
    <input type="file" id="setting-char-avatar-upload" accept="image/*" style="display:none;">
    <label for="setting-char-avatar-upload" class="btn btn-primary" style="flex-grow:1;">更换角色头像</label>
</div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                                                                                                       id="setting-char-remark">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
           <div class="avatar-setting">
    <div class="avatar-container-setting" id="my-avatar-container-setting">
        <img src="" alt="我的头像" id="setting-my-avatar-preview" class="avatar-preview">
        <!-- 头像框将动态添加在这里 -->
    </div>
    <button type="button" class="btn btn-small btn-secondary avatar-frame-btn" data-target="private-user">🌟</button>
    <input type="file" id="setting-my-avatar-upload" accept="image/*" style="display:none;">
    <label for="setting-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">更换我的头像</label>
</div>
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                                                                                            id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea
                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea>


<!-- 管理 Modal（样式与气泡预设管理一致） -->
<div id="mypersona-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;">
  <div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);">
    <h3 style="margin:0 0 10px 0;font-size:16px;">管理我的人设预设</h3>
    <div id="mypersona-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button type="button" id="mypersona-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button>
    </div>
  </div>
</div>
<!-- === /我的人设预设控制 === -->
</div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
<!-- === TTS 语音合成设置 === -->
<div class="form-group" style="background: #fff8fa; padding: 15px; border-radius: 10px; border: 1px solid #fce4ec;">
    <h4 style="color: var(--secondary-color); margin-top: 0; margin-bottom: 15px;">🎤 语音合成 (TTS)</h4>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <label for="enable-tts-switch" style="margin-bottom: 0;">启用语音合成</label>
        <input type="checkbox" id="enable-tts-switch" style="width: auto; height: 20px;">
    </div>
    
    <label for="ai-voice-id-input">语音 ID</label>
    <input type="text" id="ai-voice-id-input" placeholder="例如: female-shaonv-jingpin" style="margin-bottom: 15px;">
    
    <label for="ai-voice-lang-select">语音语言/方言</label>
    <select id="ai-voice-lang-select" style="width: 100%;">
        <option value="">自动识别 (Auto)</option>
        <option value="zh-CN">🇨🇳 国语/普通话 (Chinese)</option>
        <option value="zh-HK">🇭🇰 粤语/广东话 (Cantonese)</option>
        <option value="en-US">🇺🇸 英语 (English)</option>
        <option value="ja-JP">🇯🇵 日语 (Japanese)</option>
        <option value="ko-KR">🇰🇷 韩语 (Korean)</option>
        <option value="de-DE">🇩🇪 德语 (German)</option>
        <option value="fr-FR">🇫🇷 法语 (French)</option>
        <option value="es-ES">🇪🇸 西班牙语 (Spanish)</option>
        <option value="it-IT">🇮🇹 意大利语 (Italian)</option>
        <option value="ru-RU">🇷🇺 俄语 (Russian)</option>
    </select>
    
    <p style="font-size: 11px; color: #888; margin-top: 10px; margin-bottom: 0;">
        💡 开启后可点击AI发送的语音消息气泡播放语音。需先在API设置中配置Minimax。
    </p>
</div>

                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>


<!-- === 气泡预设控制（由 ChatGPT 插入） === -->
<!-- 插入位置：自定义气泡样式 textarea 之后（已美化外观） -->
<div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
    <label for="bubble-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">气泡预设</label>
    <select id="bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;">
      <option value="">— 选择预设 —</option>
    </select>
    <button type="button" id="apply-preset-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button>
  </div>

  <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
    <label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label>
    <button type="button" id="save-preset-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为预设</button>
    <button type="button" id="manage-presets-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button>
  </div>

  
</div>

<!-- 管理预设 modal（样式微调） -->
<div id="bubble-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;">
  <div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);">
    <h3 style="margin:0 0 10px 0;font-size:16px;">管理气泡预设</h3>
    <div id="bubble-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button type="button" id="close-presets-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button>
    </div>
  </div>
</div>
<!-- === /气泡预设控制（由 ChatGPT 插入） === -->


                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
<hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
<div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
    <label for="setting-offline-mode" style="margin-bottom: 0;">开启线下模式 (仅此角色)</label>
    <input type="checkbox" id="setting-offline-mode" style="width: auto; height: 20px;">
</div>
                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                                                                                                   id="setting-max-memory"
                                                                                                   value="10" min="1">
                </div>
	<hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
<!-- AI Proactive Chat Settings for Private Chat -->
<div class="form-group">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <label for="private-ai-proactive-chat-toggle" style="margin-bottom:0;">开启AI后台回复</label>
        <input type="checkbox" id="private-ai-proactive-chat-toggle" style="width: auto;">
    </div>
    <div id="private-ai-proactive-options" style="display: none;">
        <label for="private-ai-proactive-chat-delay">无回复超过 (分钟)</label>
        <input type="number" id="private-ai-proactive-chat-delay" min="1" placeholder="例如：30">
        <label for="private-ai-proactive-chat-interval" style="margin-top: 10px;">AI后台回复间隔时间 (分钟)</label>
        <input type="number" id="private-ai-proactive-chat-interval" min="1" placeholder="例如：60">
    </div>
</div>
<!-- START: 🆕 表情包分组绑定配置（折叠式） -->
<div class="sticker-groups-accordion" style="border-top: 1px solid #eee; padding-top: 20px; margin-bottom: 20px;">
    <!-- 折叠菜单标题栏 -->
    <div class="accordion-header" id="sticker-groups-accordion-header" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: linear-gradient(135deg, #fff8fa 0%, #fff 100%);
        border: 1px solid #fce4ec;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
    ">
        <div style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px; color: var(--secondary-color);">
                <path d="M20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12M22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2A10,10 0 0,1 22,12M10,9.5C10,10.3 9.3,11 8.5,11C7.7,11 7,10.3 7,9.5C7,8.7 7.7,8 8.5,8C9.3,8 10,8.7 10,9.5M17,9.5C17,10.3 16.3,11 15.5,11C14.7,11 14,10.3 14,9.5C14,8.7 14.7,8 15.5,8C16.3,8 17,8.7 17,9.5M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23Z"/>
            </svg>
            <span style="font-weight: 600; color: #333; font-size: 14px;">😊 表情包权限</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span id="sticker-groups-status-summary" style="font-size: 12px; color: #888;">未配置</span>
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px; color: #999; transition: transform 0.3s ease;">
                <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
            </svg>
        </div>
    </div>
    
    <!-- 折叠菜单内容 -->
    <div class="accordion-content" id="sticker-groups-accordion-content" style="
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        padding: 0 15px;
    ">
        <div style="padding-top: 15px;">
            <!-- 全选/清空按钮 -->
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button type="button" id="select-all-sticker-groups-btn" class="btn btn-small btn-secondary" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                    ✓ 全选
                </button>
                <button type="button" id="deselect-all-sticker-groups-btn" class="btn btn-small btn-neutral" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                    ✕ 清空
                </button>
            </div>
            
            <!-- 分组复选框容器 -->
            <div id="sticker-groups-selection-container" style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 8px;
                padding: 12px;
                background: #f9f9f9;
                border-radius: 8px;
                max-height: 200px;
                overflow-y: auto;
            ">
                <!-- 动态渲染复选框 -->
                <p style="color: #999; grid-column: 1/-1; text-align: center; margin: 0; font-size: 13px;">
                    📦 暂无表情包分组
                </p>
            </div>
            
            <p style="font-size: 11px; color: #888; margin-top: 10px; margin-bottom: 0;">
                💡 提示：只有勾选的分组会在 AI Prompt 中可用，可显著减少 Token 消耗。
            </p>
        </div>
    </div>
</div>
<!-- END: 表情包分组绑定配置 -->
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form><hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            	<div class="form-group">
            <button type="button" class="btn btn-secondary" id="search-history-btn">搜索聊天记录</button>
        </div>
            <!-- 聊天记录导入导出按钮 -->
            <div class="form-group">
                <button type="button" class="btn btn-primary" id="export-chat-btn">导出聊天记录</button>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary" id="import-chat-btn">导入聊天记录</button>
                <input type="file" id="import-chat-input" accept="application/json" style="display:none;">
            </div>
<button type="button" class="btn btn-danger" id="block-user-btn">拉黑</button>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list" style="max-height: 60vh; overflow-y: auto;"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <style>
        /* 世界书选择弹窗 - 折叠式列表样式 */
        .world-book-category-header {
            list-style: none;
            margin-bottom: 5px;
        }
        .world-book-category-title {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            cursor: pointer;
            user-select: none;
            background: #f5f5f5;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .world-book-category-title:hover {
            background: #e8e8e8;
        }
        .world-book-category-arrow {
            width: 16px;
            height: 16px;
            transition: transform 0.3s;
            transform: rotate(0deg);
            color: #666;
        }
        .world-book-category-arrow.expanded {
            transform: rotate(90deg);
        }
        .world-book-category-checkbox {
            margin: 0;
            cursor: pointer;
        }
        .world-book-category-items {
            list-style: none;
            padding-left: 30px;
            margin-bottom: 10px;
            display: none;
        }
        .world-book-category-items.expanded {
            display: block;
        }
        .world-book-select-item {
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .world-book-select-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        .world-book-select-item label {
            cursor: pointer;
            flex: 1;
            color: #333;
        }
        .world-book-select-item label:hover {
            color: var(--primary-color, #4c9ffe);
        }
    </style>
    <!-- Group Chat Creation Modal -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">群聊设置</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary"
                           style="flex-grow:1;">更换群头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">群名 (AI也可见)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                             <div class="avatar-setting">
    <div class="avatar-container-setting" id="group-my-avatar-container-setting">
        <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
        <!-- 头像框将动态添加在这里 -->
    </div>
    <button type="button" class="btn btn-small btn-secondary avatar-frame-btn" data-target="group-user">🌟</button>
    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
    <label for="setting-group-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">更换我的头像</label>
</div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">我的群昵称</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">我的人设</label>
                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>群成员</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group"><!-- ... 在 id="group-members-list-container" 的 div 之后 ... -->
<div class="form-group">
    <button type="button" class="btn btn-secondary" id="set-group-title-btn">设置群头衔</button>
</div>
<hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
<!-- ... 后面是 id="link-group-world-book-btn" 所在的 div ... -->
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>

                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                                                                                                         id="setting-group-max-memory"
                                                                                                         value="10"
                                                                                                         min="1"></div>
 <div class="form-group"><label for="setting-group-chat-bg-upload"
                                               class="btn btn-primary">更换聊天背景</label><input type="file"
                                                                                                  id="setting-group-chat-bg-upload"
                                                                                                  accept="image/*"
                                                                                                  style="display:none;">
                </div>
                <div class="form-group">
<label for="bubble-scale-range">气泡 + 字体大小</label>
<div style="display:flex;align-items:center;gap:10px;">
<input id="bubble-scale-range" max="1.6" min="0.8" step="0.05" style="flex:1;" type="range" value="1"/>
<span id="bubble-scale-value" style="width:56px;text-align:right;">100%</span>
</div>
<div style="margin-top:8px; color:#888; font-size:12px;">
    提示：该滑块仅影响聊天区气泡及其文字，不改变输入栏/标题栏大小。
  </div>
</div>
<hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
<!-- AI Proactive Chat Settings for Group Chat -->
<div class="form-group">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <label for="group-ai-proactive-chat-toggle" style="margin-bottom:0;">开启AI后台回复</label>
        <input type="checkbox" id="group-ai-proactive-chat-toggle" style="width: auto;">
    </div>
<div id="group-ai-proactive-options" style="display: none;">
        <label for="group-ai-proactive-chat-delay">无回复超过 (分钟)</label>
        <input type="number" id="group-ai-proactive-chat-delay" min="1" placeholder="例如：30">
        <label for="group-ai-proactive-chat-interval" style="margin-top: 10px;">AI后台回复间隔时间 (分钟)</label>
        <input type="number" id="group-ai-proactive-chat-interval" min="1" placeholder="例如：60">
    </div>
</div>
<hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"/>
                <button type="submit" class="btn btn-primary">保存设置</button>
                 </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            	<div class="form-group">
            <button type="button" class="btn btn-secondary" id="search-group-history-btn">搜索聊天记录</button>
        </div>
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">编辑群成员</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                             <div class="avatar-setting" style="justify-content: center;">
    <div class="avatar-container-setting" id="group-member-avatar-container-setting">
        <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
        <!-- 头像框将动态添加在这里 -->
    </div>
    <button type="button" class="btn btn-small btn-primary avatar-frame-btn" data-target="group-member">🌟</button>
    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
</div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">群昵称</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">真名</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">人设</label>
                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>邀请成员加入群聊</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
        </div>
    </div>
    <!-- 在这里插入音乐播放器弹窗 -->
<div id="music-player-modal" class="modal-overlay">
    <div class="modal-window">
        <div class="music-player-header">
            <h3 class="song-title">歌曲名</h3>
            <svg class="share-btn" viewBox="0 0 24 24"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z"/></svg>
        </div>
        <!-- 在 id="music-player-modal" 内找到 .music-player-body -->
<div class="music-player-body">
    <img src="https://i.postimg.cc/nzP9sgxr/chan-125.png" alt="专辑封面" class="music-album-art">
    <!-- ▼▼▼ 修改下面这一行 ▼▼▼ -->
    <div id="lyrics-panel" class="lyrics-panel">
        <p class="lyric-line">暂无歌词</p>
    </div>
    <!-- ▲▲▲ 修改结束 ▲▲▲ -->
    <div class="music-controls">
        <button class="side-btn" title="上一首"><svg viewBox="0 0 24 24"><path d="M6,18V6H8V18H6M9.5,12L18,6V18L9.5,12Z"/></svg></button>
        <button class="play-btn" title="播放/暂停"><svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg></button>
        <button class="side-btn" title="下一首"><svg viewBox="0 0 24 24"><path d="M16,18H18V6H16V18M4,18V6L13,12L4,18Z"/></svg></button>
    </div>
</div>
        <div class="music-extra-controls">
            <button title="循环模式"><svg viewBox="0 0 24 24"><path d="M17,17H7V14L3,18L7,22V19H19V13H17M7,7H17V10L21,6L17,2V5H5V11H7V7Z"/></svg></button>
            <button title="歌曲列表"><svg viewBox="0 0 24 24"><path d="M3,13H15V11H3M3,6V8H21V6M3,18H9V16H3V18Z"/></svg></button>
        </div>
    </div>
</div>
<!-- NEW: Add Category Modal -->
<div id="add-category-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>创建新分类</h3>
        <form id="add-category-form">
            <div class="form-group">
                <label for="category-name-input">分类名称</label>
                <input type="text" id="category-name-input" placeholder="例如：主要角色、地点设定" required>
            </div>
            <button type="submit" class="btn btn-primary">创建</button>
        </form>
    </div>
</div>

<!-- === 新增：头像框选择面板 === -->
<div id="avatar-frame-modal" class="modal-overlay">
    <div class="modal-window">
        <div class="modal-header">
            <h3>选择头像框</h3>
            <button id="add-avatar-frame-btn" class="btn btn-primary btn-small">+</button>
        </div>
        <div id="avatar-frame-grid">
            <!-- 头像框将由JS动态渲染于此 -->
        </div>
        <div class="modal-footer">
            <button id="remove-avatar-frame-btn" class="btn btn-danger">移除头像框</button>
            <button id="apply-avatar-frame-btn" class="btn btn-primary">应用</button>
            <button id="cancel-avatar-frame-btn" class="btn btn-neutral">取消</button>
        </div>
    </div>
</div>
<!-- =============================================================== -->
<!-- START: 新增音乐功能HTML (粘贴到 </body> 标签前) -->
<!-- =============================================================== -->

<!-- 音乐播放列表面板 -->
<div id="music-playlist-panel" class="action-sheet-overlay">
    <div class="action-sheet" style="height: 60%; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; flex-shrink: 0;">
            <h3 style="margin: 0; font-size: 16px;">播放列表</h3>
            <button id="open-add-song-modal-btn" class="btn btn-primary btn-small" style="font-size: 24px; padding: 0; width: 32px; height: 32px; border-radius: 50%;">+</button>
        </div>
        <ul id="playlist-container" class="list-container" style="flex-grow: 1; overflow-y: auto; padding: 5px;">
            <!-- 歌曲列表将由JS动态生成 -->
        </ul>
    </div>
</div>

<!-- 添加歌曲弹窗 -->
<div id="add-song-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>添加新歌曲</h3>
        <form id="add-song-form">
            <div class="form-group">
                <label for="song-url-input">歌曲URL (Catbox MP3)</label>
                <input type="url" id="song-url-input" placeholder="https://files.catbox.moe/..." required>
            </div>
            <div class="form-group">
                <label for="song-name-input">歌曲名称</label>
                <input type="text" id="song-name-input" placeholder="歌曲的名称" required>
            </div>
             <div class="form-group">
                <label for="song-artist-input">艺术家</label>
                <input type="text" id="song-artist-input" placeholder="演唱者/艺术家" required>
            </div>
            <div class="form-group">
                <label for="song-album-art-input">专辑封面URL (选填)</label>
                <input type="url" id="song-album-art-input" placeholder="https://...">
            </div>
            <div class="form-group">
                <label for="song-lyrics-input">歌词内容 (选填)</label>
                <textarea id="song-lyrics-input" rows="5" placeholder="在此处粘贴 .lrc 文件内容..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">添加</button>
        </form>
    </div>
</div>

<!-- 分享音乐弹窗 -->
<div id="share-music-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>分享音乐给...</h3>
        <ul id="share-music-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto;">
            <!-- 聊天对象列表将由JS动态生成 -->
        </ul>
        <button id="confirm-music-share-btn" class="btn btn-primary" style="margin-top: 20px;">确认分享</button>
    </div>
</div>

<!-- 全局音频播放器 -->
<audio id="global-audio-player"></audio>
<audio id="tts-audio-player" style="display:none;"></audio>

<!-- 用于上传LRC文件的隐藏输入框 -->
<input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
<!-- 音乐播放器弹窗结束 -->

    <!-- Message Edit Modal (编辑消息弹窗) -->
    <div id="message-edit-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>编辑消息</h3>
            <form id="message-edit-form">
                <div class="form-group">
                    <textarea id="message-edit-textarea" rows="6" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                    <button type="button" id="cancel-edit-modal-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色并加入群聊</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"
                         id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">群昵称</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">真名</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">人设</label>
                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">创建并加入</button>
            </form>
        </div>
    </div>
<!-- =============================================================== -->
<!-- START: 新增钱包功能HTML (粘贴到 </body> 标签前) -->
<!-- =============================================================== -->
<!-- START: 新增聊天记录搜索弹窗 -->
<div id="search-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>搜索当前聊天记录</h3>
        <form id="search-modal-form">
            <div class="form-group">
                <input type="search" id="search-modal-input" class="form-group" placeholder="输入关键词..." required>
            </div>
            <button type="submit" class="btn btn-primary">搜索</button>
        </form>
    </div>
</div>
<!-- END: 新增聊天记录搜索弹窗 -->
<!-- 1. 钱包主界面 Screen -->
<div id="wallet-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container">
            <h1 class="title">我的钱包</h1>
        </div>
       <div class="action-btn-group">
    <button class="action-btn" id="wallet-settings-btn">设置</button>
</div>
    </header>
    <main class="content" style="padding: 20px; background-color: #f9f9f9;">
        <div class="wallet-balance-card">
            <p class="wallet-balance-label">零花钱余额 (元)</p>
            <p class="wallet-balance-amount" id="wallet-balance-display">0.00</p>
        </div>
        <div class="wallet-actions-list">
            <div class="wallet-action-item" id="show-transactions-btn">
                <span>零花钱明细</span>
                <span>›</span>
            </div>
        </div>
    </main>
</div>
<!-- START: 新增聊天记录搜索结果页面 -->
<div id="search-results-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="chat-room-screen">‹</button>
        <div class="title-container">
            <h1 class="title">搜索结果</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <ul class="list-container" id="search-results-list">
            <!-- 搜索结果将由JS动态生成 -->
        </ul>
        <div class="placeholder-text" id="no-search-results-placeholder" style="display: none;">
            <p>未找到相关聊天记录</p>
        </div>
    </main>
</div>
<!-- END: 新增聊天记录搜索结果页面 -->
<!-- 2. 钱包设置界面 Screen -->
<div id="wallet-settings-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="wallet-screen">‹</button>
        <div class="title-container">
            <h1 class="title">支付设置</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <form id="wallet-settings-form">
    <div class="form-group">
    <label for="wallet-balance-input">设置零花钱余额</label>
    <input type="number" id="wallet-balance-input" placeholder="0.00" step="0.01" min="0">
</div>

<div class="form-group toggle-group">
    <label for="wallet-password-enabled-toggle" style="margin-bottom:0;">启用支付密码</label>
    <label class="toggle-switch">
        <input type="checkbox" id="wallet-password-enabled-toggle">
        <span class="slider"></span>
    </label>
</div>
<div class="form-group">
    <label for="wallet-password-input">设置/修改支付密码 (6位数字)</label>
    <input type="password" id="wallet-password-input" pattern="\d{6}" maxlength="6" inputmode="numeric">
</div>
            <button type="submit" class="btn btn-primary">保存设置</button>
        </form>
    </main>
</div>

<!-- 3. 零花钱明细弹窗 Modal -->
<div id="transaction-details-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>零花钱明细</h3>
        <ul id="transaction-list-container" class="list-container" style="max-height: 60vh; overflow-y: auto;">
            <!-- 明细将由JS动态生成 -->
        </ul>
        <button class="btn btn-primary" id="close-transactions-btn" style="margin-top: 20px;">关闭</button>
    </div>
</div>

<!-- 4. 支付密码输入弹窗 Modal -->
<div id="payment-password-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="payment-prompt-title">请输入支付密码</h3>
        <p id="payment-prompt-description" style="text-align:center; color:#666;"></p>
        <div class="form-group">
            <input type="password" id="payment-password-input" pattern="\d{6}" maxlength="6" inputmode="numeric" style="text-align:center; font-size: 20px; letter-spacing: 1em;">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-neutral" id="cancel-payment-btn" style="flex: 1;">取消</button>
            <button class="btn btn-primary" id="confirm-payment-btn" style="flex: 1;">确认</button>
        </div>
    </div>
</div>

<!-- =============================================================== -->
<!-- END: 新增钱包功能HTML -->
<!-- =============================================================== -->
<!-- ▼▼▼ 在这里粘贴下面的新代码 ▼▼▼ -->
<!-- AI POV: Character Selection Screen -->
<div id="ai-character-select-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container">
            <h1 class="title">选择AI视角</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <ul class="list-container" id="ai-character-select-list"></ul>
        <div class="placeholder-text" id="no-ai-chars-placeholder" style="display: none;">
            <p>还没有创建任何AI角色哦~</p>
        </div>
    </main>
</div>

<!-- AI POV: AI's Chat List Screen -->
<div id="ai-chat-list-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-character-select-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="ai-chat-list-title">的聊天列表</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <ul class="list-container" id="ai-chat-list-container"></ul>
         <div class="placeholder-text" id="no-ai-chats-placeholder" style="display: none;">
            <p>Ta还没有和别人聊过天哦~</p>
        </div>
    </main>
</div>

<!-- AI POV: AI's Conversation View Screen -->
<div id="ai-chat-view-screen" class="screen">
   <header class="app-header">
    <button class="back-btn" data-target="ai-chat-list-screen">‹</button>
    <div class="title-container">
        <h1 class="title" id="ai-chat-view-title">与...的对话</h1>
    </div>
    <div class="placeholder"></div>
   </header>
    <main class="content">
        <div class="message-area" id="ai-message-area"></div>
    </main>
    <!-- 这个屏幕是只读的，所以没有输入框 -->
</div>
<!-- ▲▲▲ 新代码粘贴到这里结束 ▲▲▲ -->
<!-- === Modal 结束 === -->
<div id="voice-call-overlay">
    <img src="" alt="Avatar" class="call-avatar-large" id="call-avatar">
    <h2 class="call-name" id="call-name">...</h2>
    <p class="call-status" id="call-status">正在呼叫...</p>

    <div id="ringing-view">
        <div class="call-button-group" id="incoming-buttons" style="display: none;">
            <button class="call-button decline" id="decline-call-btn">
                <div class="icon-wrapper"><svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 9,10.4 9,12S10.4,15 12,15 15,13.6 15,12 13.6,9 12,9M12,17.25C9.24,17.25 6.75,15.17 6.75,12.5C6.75,11.05 7.42,9.73 8.5,8.81L15.19,15.5C14.27,16.58 12.95,17.25 12,17.25M17.25,12C17.25,14.76 15.17,17.25 12.5,17.25C11.05,17.25 9.73,16.58 8.81,15.5L15.5,8.81C16.58,9.73 17.25,11.05 17.25,12M4.44,3L3,4.44L8.06,9.5C7.36,10.23 6.84,11.08 6.5,12H4.13C4.5,14.75 6.13,17.13 8.5,18.5V22H15.5V18.5C16.92,17.81 18.1,16.81 18.91,15.56L20.56,17.22L21.94,15.84L4.44,3Z" /></svg></div>
                <span>拒接</span>
            </button>
            <button class="call-button accept" id="accept-call-btn">
                <div class="icon-wrapper"><svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg></div>
                <span>接听</span>
            </button>
        </div>
        <div class="call-button-group" id="outgoing-buttons" style="display: none;">
            <button class="call-button decline" id="cancel-call-btn">
                 <div class="icon-wrapper"><svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 9,10.4 9,12S10.4,15 12,15 15,13.6 15,12 13.6,9 12,9M12,17.25C9.24,17.25 6.75,15.17 6.75,12.5C6.75,11.05 7.42,9.73 8.5,8.81L15.19,15.5C14.27,16.58 12.95,17.25 12,17.25M17.25,12C17.25,14.76 15.17,17.25 12.5,17.25C11.05,17.25 9.73,16.58 8.81,15.5L15.5,8.81C16.58,9.73 17.25,11.05 17.25,12M4.44,3L3,4.44L8.06,9.5C7.36,10.23 6.84,11.08 6.5,12H4.13C4.5,14.75 6.13,17.13 8.5,18.5V22H15.5V18.5C16.92,17.81 18.1,16.81 18.91,15.56L20.56,17.22L21.94,15.84L4.44,3Z" /></svg></div>
                <span>取消</span>
            </button>
        </div>
    </div>

 <div id="call-transcript-area"></div>
    <div class="call-button-group" id="hangup-button-container">
        <button class="call-button decline" id="hangup-call-btn">
            </button>
    </div>
    <div id="call-input-area">
        <input type="text" id="call-input" placeholder="输入文字...">
        <button id="send-call-message-btn">➤</button>
    </div>
</div>
</div>
  
</div>
<input type="file" id="import-data-input" accept=".ee" style="display: none;">	






<!-- === ChatGPT 插入：气泡预设脚本 === -->

<!-- === /ChatGPT 插入：气泡预设脚本 === -->





<!-- === ChatGPT 插入：API 预设脚本 === -->





<!-- === /我的人设预设脚本 === -->
<!-- ================= Moments 页面（动态） ================= -->
<div class="screen" id="moments-screen" style="display:none;">
  <header class="app-header">
    <button class="back-btn" data-target="chat-list-screen">‹</button>
    <div class="title-container"><h1 class="title">动态</h1></div>
    <div class="action-btn-group">
      <button class="action-btn" id="moments-delete-btn">删除</button>
      <button class="action-btn" id="open-post-modal">发布</button>
    </div>
  </header>
  <main class="content" id="moments-list">

<!-- === BEGIN ICITY-STYLE USER HEADER SNIPPET (inserted by assistant) === -->


<div class="icity-moments-wrap" id="icity-moments-wrap">
  <div class="icity-moments-inner" role="region" aria-label="用户动态头部">
    <div class="icity-hero" id="icity-hero"></div>

    <!-- 头像 -->
    <div class="icity-avatar-wrap" id="icity-avatar-wrap" aria-hidden="false">
      <!-- 默认头像：纯白圆（可替换为 dataURL 或真实图片） -->
      <img id="icity-avatar" alt="头像" src="data:image/svg+xml;utf8,
        %3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E
        %3Crect width='100%25' height='100%25' fill='%23ffffff'/%3E
        %3C/svg%3E" />
    </div>

    <!-- 信息白卡 -->
    <div class="icity-info-card">
      <h2 class="icity-name" id="icity-name">Skeleton</h2>

      <div class="icity-id-loc">
        <span class="icity-id">ID：<strong id="icity-id">user</strong></span>
        <span style="opacity:0.4;">·</span>
        <span class="icity-loc"><span class="dot"></span><span id="icity-loc-text">自定义定位</span></span>
      </div>

      <div class="icity-signature" id="icity-signature">把心情写在这里吧♥</div>
    </div>
  </div>
</div>


<!-- === END ICITY-STYLE USER HEADER SNIPPET === -->

    <p class="placeholder-text" id="moments-empty">还没有动态，点击右上角发布吧~</p>
    <div id="moments-container"></div>
  </main>
</div>

<!-- 发布动态模态框 -->
<div class="modal-overlay" id="post-modal" style="display:none;">
  <div class="modal-window">
    <h3>发布动态</h3>
    <form id="post-form">
      <div class="form-group">
        <label>动态内容</label>
        <textarea id="post-text" placeholder="说点什么..." required rows="4"></textarea>
      </div>
      <div class="form-group">
        <label><input type="checkbox" id="add-image"> 添加图片</label>
      </div>
      <div class="form-group" id="image-input-group" style="display:none;">
  <label>图片描述</label>
  <input type="text" id="image-description" placeholder="描述图片内容（如：海边日落）">
</div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn btn-secondary" type="button" id="cancel-post-btn">取消</button>
        <button class="btn btn-primary" type="submit">发布</button>
      </div>
    </form>
  </div>
</div>




<!-- 在聊天界面底部插入导航（你指定的位置：聊天界面底部） -->
<div id="bottom-nav-host" data-managed-by="injection" style="display:none;">
  <div class="bottom-nav" id="bottom-nav">
    <button class="nav-btn active" data-target="chat-list-screen">聊天</button>
    <button class="nav-btn" data-target="moments-screen">动态</button>
    <button class="nav-btn" data-target="wallet-screen">我</button>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>








<!-- === /patch === -->


<!-- End assistant-inserted CSS -->

<!-- === Avatar & Background Edit Feature === -->
<div class="action-sheet-overlay" id="edit-top-section-actionsheet">
  <div class="action-sheet">
    <button class="action-sheet-button" id="edit-bg-btn">更换背景图</button>
    <button class="action-sheet-button" id="edit-avatar-btn">更换头像</button>
    <button class="action-sheet-button danger" id="cancel-edit-top-btn">取消</button>
  </div>
</div>
<input type="file" accept="image/*" id="top-section-file-input" style="display:none;" />





<!-- Remove/hide avatars in moments list while preserving top avatar -->







<!-- Moments 多选删除底部操作栏 -->
<div id="moments-multi-select-bar" class="multi-select-bar" aria-hidden="true">
  <div class="msb-left">
    <span id="moments-selected-count">已选择 0 项</span>
  </div>
  <div class="msb-right">
    <button id="moments-confirm-delete" class="danger">确认删除</button>
    <button id="moments-cancel-delete">取消</button>
  </div>
</div>









<script id="moments-delete-feature-script">
    (function() {
        // 防止脚本被重复执行
        if (window.momentsDeleteFeatureInitialized) {
            return;
        }
        window.momentsDeleteFeatureInitialized = true;

        // 步骤 A: 动态注入正确的CSS样式
        // 这样做可以强制覆盖掉任何可能残留的、导致按钮消失的旧样式
        const css = `
            #moments-screen.is-delete-mode .moment-item { 
                cursor: pointer; user-select: none; 
            }
            .moment-item.is-selected { 
                outline: 2px solid var(--accent-color, #4c9ffe); 
                position: relative; 
                border-radius: 14px;
                box-shadow: 0 6px 18px rgba(76, 159, 254, 0.2) !important;
            }
            .moment-item.is-selected::after {
              content: '✓';
              position: absolute; right: 8px; top: 8px;
              width: 22px; height: 22px; line-height: 22px; text-align: center;
              border-radius: 50%;
              background: rgba(0,0,0,.6); color: #fff; font-weight: 700; font-size: 14px;
              z-index: 10;
            }
            /* 关键修正：强制确保按钮文字在任何情况下都可见 */
            #moments-screen.is-delete-mode .app-header #moments-delete-btn {
                font-size: 16px !important;
            }
            /* 关键修正：强制清除可能残留的、导致文字被替换的旧样式 */
            #moments-screen.is-delete-mode .app-header #moments-delete-btn::before {
                content: "" !important;
            }
        `;
        const style = document.createElement('style');
        style.type = 'text/css';
        style.appendChild(document.createTextNode(css));
        document.head.appendChild(style);

        // 步骤 B: 绑定功能逻辑
        document.addEventListener('DOMContentLoaded', () => {
            const momentsScreen = document.getElementById('moments-screen');
            const deleteBtn = document.getElementById('moments-delete-btn');
            
            if (!momentsScreen || !deleteBtn) {
                console.error("动态删除功能初始化失败：找不到关键HTML元素。");
                return;
            }

            let selectedMomentsIds = new Set();

            function updateDeleteButtonState() {
                const isInDeleteMode = momentsScreen.classList.contains('is-delete-mode');
                if (!isInDeleteMode) {
                    deleteBtn.textContent = '删除';
                    deleteBtn.style.color = '';
                    deleteBtn.style.fontWeight = '';
                } else {
                    if (selectedMomentsIds.size > 0) {
                        deleteBtn.textContent = `删除 (${selectedMomentsIds.size})`;
                        deleteBtn.style.color = '#ef5350'; // 红色
                        deleteBtn.style.fontWeight = '600';
                    } else {
                        deleteBtn.textContent = '取消';
                        deleteBtn.style.color = 'var(--primary-color)'; // 主题色
                        deleteBtn.style.fontWeight = '600';
                    }
                }
            }

            function enterDeleteMode() {
                momentsScreen.classList.add('is-delete-mode');
                updateDeleteButtonState();
                if(typeof showToast === 'function') showToast('已进入选择模式');
            }

            function exitDeleteMode() {
                momentsScreen.classList.remove('is-delete-mode');
                document.querySelectorAll('.moment-item.is-selected').forEach(el => el.classList.remove('is-selected'));
                selectedMomentsIds.clear();
                updateDeleteButtonState();
            }
            
            async function confirmAndDelete() {
                if (confirm(`确定要删除选中的 ${selectedMomentsIds.size} 条动态吗？`)) {
                    try {
                        if (window.AppDB_Moments && typeof window.AppDB_Moments.moments.bulkDelete === 'function') {
                            await window.AppDB_Moments.moments.bulkDelete(Array.from(selectedMomentsIds));
                            if(typeof showToast === 'function') showToast('动态已成功删除');
                            exitDeleteMode();
                            if (typeof window.renderMomentsSafe === 'function') await window.renderMomentsSafe();
                        } else { throw new Error("数据库功能不可用。"); }
                    } catch (error) {
                        console.error('删除动态失败:', error);
                        if(typeof showToast === 'function') showToast('删除失败: ' + error.message);
                    }
                }
            }

            deleteBtn.addEventListener('click', () => {
                const isInDeleteMode = momentsScreen.classList.contains('is-delete-mode');
                if (!isInDeleteMode) {
                    enterDeleteMode();
                } else {
                    if (selectedMomentsIds.size > 0) {
                        confirmAndDelete();
                    } else {
                        exitDeleteMode();
                        if(typeof showToast === 'function') showToast('已取消选择');
                    }
                }
            });

            momentsScreen.addEventListener('click', (e) => {
                if (!momentsScreen.classList.contains('is-delete-mode')) return;
                const momentItem = e.target.closest('.moment-item');
                if (momentItem) {
                    e.stopPropagation(); e.preventDefault();
                    const momentId = momentItem.dataset.id;
                    if (!momentId) return;
                    if (selectedMomentsIds.has(momentId)) {
                        selectedMomentsIds.delete(momentId);
                        momentItem.classList.remove('is-selected');
                    } else {
                        selectedMomentsIds.add(momentId);
                        momentItem.classList.add('is-selected');
                    }
                    updateDeleteButtonState();
                }
            }, true);
            
            // 确保在init函数中调用过setupMomentsDeleteFeature后，这里的逻辑也能被正确执行
            if (typeof setupMomentsDeleteFeature === 'function') {
                console.log("setupMomentsDeleteFeature is already defined, skipping re-definition but ensuring execution.");
            }
        });
    })();
</script>

<div id="home-profile-edit-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>更换图片</h3>
        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 25px;">
            <button class="btn btn-primary" id="edit-profile-from-url-btn">输入网络URL</button>
            <button class="btn btn-secondary" id="edit-profile-from-local-btn">从本地上传</button>
            <button class="btn btn-neutral" id="cancel-edit-profile-btn" style="margin-top: 10px;">取消</button>
        </div>
    </div>
</div>
<input type="file" id="home-profile-image-upload" accept="image/*" style="display:none;">


<div id="customize-icon-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="customize-icon-modal-title">自定义图标</h3>
        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 25px;">
            <button class="btn btn-primary" id="icon-edit-from-url-btn">输入网络URL</button>
            <button class="btn btn-secondary" id="icon-edit-from-local-btn">从本地上传</button>
            <button class="btn btn-danger" id="icon-edit-reset-btn" style="margin-top: 10px;">恢复默认</button>
            <button class="btn btn-neutral" id="icon-edit-cancel-btn">取消</button>
        </div>
    </div>
</div>
<input type="file" id="customize-icon-upload" accept="image/*" style="display:none;">
  
<!-- 在 </body> 之前添加 -->


    <div id="mention-panel" class="mention-panel"></div>

   
   

  
<div id="trajectory-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="trajectory-modal-title">Ta的轨迹</h3>
        <div id="trajectory-timeline">
            <div class="placeholder-text">正在加载轨迹...</div>
        </div>
        <button id="close-trajectory-modal-btn" class="btn btn-primary" style="margin-top: 20px;">关闭</button>
    </div>
</div>
<!-- === 新增：“心声”功能弹窗 === -->
<div id="heart-sound-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="heart-sound-modal-title">Ta的心声</h3>
        <div id="heart-sound-content" style="max-height: 60vh; overflow-y: auto; background-color: #f9f9f9; padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.7;">
            <div class="placeholder-text">正在倾听心声...</div>
        </div>
        <button id="close-heart-sound-modal-btn" class="btn btn-primary" style="margin-top: 20px;">关闭</button>
    </div>
</div>
<div id="mention-panel" class="mention-panel"></div>
<!-- ... (El resto de los scripts y styles finales) ... -->
<!-- ... 紧跟在最后一个 modal 的 div 之后 ... -->
<div id="set-group-title-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>选择要设置头衔的成员</h3>
        <ul id="group-title-member-list" class="list-container" style="max-height: 60vh; overflow-y: auto;">
            <!-- Member list will be populated by JS -->
        </ul>
        <button class="btn btn-neutral" id="close-group-title-modal-btn" style="margin-top: 20px;">关闭</button>
    </div>
</div>
<!-- =============================================================== -->
<!-- START: "每日一问" & "情绪天气" 功能模块 -->
<!-- =============================================================== -->

<!-- 1. 每日一问的弹窗 -->
<div id="bond-daily-question-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>每日一问</h3>
        <div id="daily-question-content" style="min-height: 100px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 15px; white-space: pre-wrap; line-height: 1.7;">
            <p id="daily-question-text" style="font-size: 16px; color: #333;"></p>
        </div>
        <form id="daily-question-answer-form">
            <input type="hidden" id="current-daily-question-text">
            <div class="form-group">
                <textarea id="daily-question-answer" rows="4" placeholder="写下你的回答..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">提交回答</button>
        </form>
    </div>
</div>

<!-- 2. 情绪天气的弹窗 -->
<div id="bond-mood-weather-modal" class="modal-overlay">
    <div class="modal-window" style="text-align: center;">
        <h3 id="mood-weather-title">Ta现在的心情</h3>
        <div id="mood-weather-icon" style="font-size: 80px; margin: 20px 0;">☀️</div>
        <p id="mood-weather-reason" style="background-color: #f9f9f9; padding: 15px; border-radius: 8px; font-style: italic; color: #555;"></p>
        <button id="soothe-ai-btn" class="btn btn-secondary" style="display: none; margin-top: 15px;">安抚Ta</button>
    </div>
</div>

<!-- 3. 新增页面：情侣问答手册 -->
<div id="bond-q-and-a-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="soul-bond-screen">‹</button>
        <div class="title-container">
            <h1 class="title">问答手册</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <ul class="list-container" id="q-and-a-list-container">
            <!-- 问答记录将由JS动态生成 -->
        </ul>
        <p class="placeholder-text" id="no-q-and-a-placeholder" style="display: none;">还没有问答记录哦</p>
    </main>
</div>

<!-- =============================================================== -->
<!-- END: "每日一问" & "情绪天气" 功能模块 -->
<!-- =============================================================== -->
<!-- ... 后面是 </body> -->
<!-- =============================================================== -->
<!-- START: 交换日记内容查看器 (Modal) -->
<!-- =============================================================== -->
<div id="diary-exchange-viewer-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 95%; height: 80vh; display: flex; flex-direction: column; padding: 15px;">
        <h3 id="diary-viewer-title" style="text-align: center; margin-bottom: 15px; flex-shrink: 0;">交换日记</h3>
        <div id="diary-viewer-content" style="flex-grow: 1; overflow-y: auto; background-color: #fafafa; padding: 15px; border-radius: 8px;">
            <!-- 日记内容将由JS动态生成 -->
        </div>
        <button id="close-diary-viewer-btn" class="btn btn-primary" style="margin-top: 15px; flex-shrink: 0;">关闭</button>
    </div>
</div>
<!-- =============================================================== -->
<!-- END: 交换日记内容查看器 -->
<!-- =============================================================== -->
<!-- START: 升级后的渲染器编辑弹窗 -->
<div id="edit-renderer-rule-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 95%;">
        <h3>创建/编辑渲染规则</h3>
        <form id="edit-renderer-rule-form">
            <input type="hidden" id="renderer-rule-id">
            <div class="form-group">
                <label for="renderer-rule-name">规则名称</label>
                <input type="text" id="renderer-rule-name" placeholder="为你的规则起个名字" required>
            </div>
            <div class="form-group">
                <label>查找正则表达式 (Regex)</label>
                <textarea id="renderer-rule-regex" rows="3" placeholder="例如：<L>([^<]+)<\/L>" required></textarea>
                <div class="regex-flags-container">
                    <label><input type="checkbox" id="regex-flag-g" value="g" checked>全局(g)</label>
                    <label><input type="checkbox" id="regex-flag-i" value="i">忽略大小写(i)</label>
                    <label><input type="checkbox" id="regex-flag-s" value="s">点匹配换行(s)</label>
                </div>
            </div>
            <div class="form-group">
                <label for="renderer-rule-html">HTML 替换代码 (使用 $1, $2 引用捕获组)</label>
                <textarea id="renderer-rule-html" rows="5" placeholder="例如：<div style='color:blue;'>$1</div>"></textarea>
            </div>
             <div class="form-group">
                <label for="renderer-rule-trim">修剪字符串 (每行一个)</label>
                <textarea id="renderer-rule-trim" rows="2" placeholder="在匹配前，会先从消息中移除这里列出的所有字符串。"></textarea>
            </div>
          <div class="renderer-options-grid">
        <div class="form-group">
            <label>作用范围</label>
            <div class="scope-options">
                <label><input type="checkbox" name="renderer-scope" value="user"> 用户输入</label>
                <label><input type="checkbox" name="renderer-scope" value="ai" checked> AI输出</label>
            </div>
        </div>
        <div class="form-group">
            <label>其他选项</label>
            <div class="scope-options">
               <label><input type="checkbox" id="renderer-rule-enabled" checked> 启用此规则</label>
               <!-- 新增：优先级输入框 -->
               <label style="margin-left: 15px;">优先级: <input type="number" id="renderer-rule-priority" value="50" style="width: 60px; padding: 5px; border-radius: 6px; border: 1px solid #ddd;"></label>
            </div>
        </div>
    </div>
    <!-- END: 修改“其他选项”部分 -->
            <div class="form-group">
                <label>绑定角色 (规则仅对选中的角色生效)</label>
                <div id="renderer-char-binding-list" class="char-binding-list"></div>
            </div>
            <hr style="border:none; border-top:1px solid #f0f0f0; margin: 20px 0;">
    <div class="form-group">
        <label for="renderer-rule-test-input">测试预览</label>
        <textarea id="renderer-rule-test-input" rows="3" placeholder="在此输入要测试的内容，例如：<L>你好</L>"></textarea>
    </div>
    <div class="form-group">
        <label>预览效果</label>
        <div id="renderer-rule-preview-output" style="border: 1px solid #eee; padding: 15px; border-radius: 8px; min-height: 50px; background: #f9f9f9; line-height: 1.6; word-wrap: break-word;"></div>
    </div>
            <button type="submit" class="btn btn-primary">保存规则</button>
        </form>
    </div>
</div>
<!-- END: 升级后的渲染器编辑弹窗 -->
<div id="renderer-category-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>创建新分类</h3>
        <form id="renderer-category-form">
            <div class="form-group">
                <label for="renderer-category-name">分类名称</label>
                <input type="text" id="renderer-category-name" placeholder="例如：通用效果、角色专属" required>
            </div>
            <button type="submit" class="btn btn-primary">创建</button>
        </form>
    </div>
</div>
<!-- END: 新增渲染器编辑弹窗 -->
	<!-- =============================================================== -->
<!-- START: 新增“交换日记”功能界面 -->
<!-- =============================================================== -->

<!-- 1. 交换日记列表页面 -->
<div id="bond-diary-exchange-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="soul-bond-screen">‹</button>
        <div class="title-container">
            <h1 class="title">交换日记</h1>
        </div>
        <button class="action-btn" id="write-new-exchange-btn" style="font-size: 28px;">+</button>
    </header>
    <main class="content">
        <div id="diary-exchange-list-container">
            <!-- 交换日记条目将由JS动态生成 -->
        </div>
        <p class="placeholder-text" id="no-diary-exchanges-placeholder" style="display: none;">还没有交换过日记，点击右上角“+”开始第一篇吧！</p>
    </main>
</div>

<!-- 2. 写交换日记的弹窗 -->
<div id="write-diary-exchange-modal" class="modal-overlay">
    <div class="modal-window" style="max-height: 85vh; display: flex; flex-direction: column;">
        <h3>写给Ta的日记</h3>
        <form id="diary-exchange-form" style="overflow-y: auto; flex-grow: 1; padding: 5px;">
            <div class="form-group">
                <textarea id="exchange-diary-content" rows="10" required placeholder="写下你想对Ta说的话..."></textarea>
            </div>
            <div class="form-group">
                <label for="exchange-diary-image-upload" class="btn btn-secondary">附上一张图片 (可选)</label>
                <input type="file" id="exchange-diary-image-upload" accept="image/*" style="display:none;">
                <div id="exchange-diary-image-preview" style="width: 100px; height: 100px; border: 1px dashed #ccc; margin: 10px auto 0; background-size: cover; background-position: center; display: none;"></div>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 15px;">发送日记</button>
        </form>
    </div>
</div>
<!-- =============================================================== -->
<!-- START: "想你啦" 功能模块 -->
<!-- =============================================================== -->
<div id="miss-you-actionsheet" class="action-sheet-overlay">
    <div class="action-sheet">
        <button class="action-sheet-button" data-level="有点想你">有点想你...</button>
        <button class="action-sheet-button" data-level="非常想你">非常想你！</button>
        <button class="action-sheet-button danger" id="cancel-miss-you-btn">取消</button>
    </div>
</div>
<!-- =============================================================== -->
<!-- END: "想你啦" 功能模块 -->
<!-- =============================================================== -->
<!-- =============================================================== -->
<!-- END: “交换日记”功能界面 -->
<!-- =============================================================== -->
<!-- START: 心灵羁绊 - 绑定功能界面 -->
<!-- =============================================================== -->

<!-- 1. 绑定邀请主页面 -->
<div id="bond-invitation-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container"><h1 class="title">心灵羁绊</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <div class="bond-invite-card">
            <h2>绑定情侣关系，享情侣权益</h2>
            <p>立即邀请你的心动对象，开启一场心灵之旅吧</p>
            <div class="bond-invite-avatars">
                <div class="bond-avatar-placeholder" id="bond-invite-my-avatar">
                    <!-- My avatar will be rendered here -->
                </div>
                <span class="heart-connector">❤️</span>
                <div class="bond-avatar-placeholder invitee" id="bond-invite-ai-avatar">
                    <span>+</span>
                </div>
            </div>
            <button class="bond-invite-btn" id="bond-invite-main-btn">立即邀请</button>
        </div>
    </main>
</div>

<!-- 2. 选择邀请对象的弹窗 -->
<div id="bond-invite-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>选择一个心动对象</h3>
        <ul id="bond-invite-selection-list" class="list-container" style="max-height: 50vh; overflow-y: auto;">
            <!-- AI列表将由JS动态生成 -->
        </ul>
    </div>
</div>

<!-- =============================================================== -->
<!-- END: 心灵羁绊 - 绑定功能界面 -->
<!-- =============================================================== -->	
<!-- =============================================================== -->
<!-- 放在 </body> 标签之前 -->
<input type="file" id="card-import-input" accept=".json,.png" style="display: none;">
	<!-- === 新增：长截图预览弹窗 === -->
<div id="screenshot-preview-modal" class="modal-overlay" style="z-index: 1001;">
    <div class="modal-window" style="max-width: 95%; padding: 15px;">
        <h3 style="text-align: center; margin-bottom: 15px;">长截图预览</h3>
        <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #eee; text-align: center;">
            <img id="screenshot-preview-image" src="" alt="截图预览" style="max-width: 100%; display: block;">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="close-screenshot-preview" class="btn btn-neutral" style="flex: 1;">关闭</button>
            <a id="download-screenshot-btn" class="btn btn-primary" style="flex: 1; text-decoration: none;" href="#" download="聊天记录截图.png">保存图片</a>
        </div>
    </div>
</div>
<input type="file" id="renderer-import-input" accept=".json" style="display: none;" multiple>
	<!-- === 新增：查看已撤回消息内容的弹窗 === -->
<div id="view-recalled-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>已撤回的消息</h3>
        <div class="form-group" style="max-height: 60vh; overflow-y: auto; background-color: #f9f9f9; padding: 10px; border-radius: 8px;">
            <pre id="recalled-content-display" style="white-space: pre-wrap; word-wrap: break-word; font-size: 14px; color: #333;"></pre>
        </div>
        <button id="close-recalled-modal-btn" class="btn btn-primary" style="margin-top: 20px;">关闭</button>
    </div>
</div>
<!-- === 新增：日记功能扩展面板与页面 === -->

<!-- 1. 打开日记功能时的操作选择面板 -->
<div id="diary-actionsheet" class="action-sheet-overlay">
    <div class="action-sheet">
        <button class="action-sheet-button" id="open-ai-diary-btn">Ta的日记</button>
        <button class="action-sheet-button" id="open-user-diary-btn">我的日记</button>
        <button class="action-sheet-button" id="open-write-user-diary-btn">写日记</button>
    </div>
</div>

<!-- 2. “我的日记”显示页面 -->
<div id="user-diary-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="chat-room-screen">‹</button>
        <div class="title-container">
            <h1 class="title">我的日记</h1>
        </div>
        <button class="action-btn" id="ai-peek-btn">偷看</button>
    </header>
    <main class="content">
        <ul class="list-container" id="user-diary-list-container"></ul>
        <div class="placeholder-text" id="no-user-diaries-placeholder" style="display: none;">
            <p>你还没有写过日记哦~</p>
            <p>从聊天界面打开日记功能，点击“写日记”开始吧！</p>
        </div>
    </main>
</div>

<!-- 3. 用户“写日记”的弹窗 -->
<div id="write-user-diary-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>写下今天的心情...</h3>
        <form id="write-user-diary-form">
            <input type="hidden" id="editing-user-diary-id">
            <div class="form-group">
                <textarea id="user-diary-content-input" rows="10" required placeholder="今天发生了什么..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">保存日记</button>
        </form>
    </div>
</div>

<!-- 4. 选择哪个AI来“偷看”日记的弹窗 -->
<div id="ai-peek-selection-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>让谁来偷看呢？</h3>
        <ul id="ai-peek-selection-list" class="list-container" style="max-height: 50vh; overflow-y: auto;">
            <!-- AI列表将由JS动态生成 -->
        </ul>
        <button class="btn btn-secondary" id="ai-auto-peek-btn" style="margin-top: 15px;">让老天爷决定 (自动)</button>
    </div>
</div>

<!-- START: 批量添加表情包弹窗 -->
<div id="batch-add-sticker-modal" class="modal-overlay">
    <div class="modal-window">
        <!-- Step 1: Upload View -->
        <div id="batch-upload-view">
            <h3>批量添加表情包</h3>
            <!-- 🆕 新增：分组名称输入框（带建议列表） -->
            <div class="form-group">
                <label for="batch-sticker-group-input">分组名称（选填，本批次所有表情将归入此组）</label>
                <input type="text" 
                       id="batch-sticker-group-input" 
                       list="batch-sticker-group-suggestions"
                       placeholder="如：猫猫组、通用组（留空则为"未分类"）"
                       autocomplete="off">
                <datalist id="batch-sticker-group-suggestions">
                    <!-- 动态渲染已有分组 -->
                </datalist>
            </div>
            <div class="form-group">
                <label for="batch-sticker-files-upload" class="btn btn-primary">
                    从本地选择多个文件
                </label>
                <input type="file" id="batch-sticker-files-upload" accept="image/*" multiple style="display:none;">
            </div>
            <p style="text-align:center; color:#888; margin: 15px 0;">或</p>
            <div class="form-group">
                <label for="batch-sticker-urls-input">粘贴多个URL (英文逗号隔开)</label>
                <textarea id="batch-sticker-urls-input" rows="5" placeholder="https://.../1.png,https://.../2.gif,..."></textarea>
            </div>
            <button class="btn btn-secondary" id="process-batch-stickers-btn">下一步</button>
        </div>

        <!-- Step 2: Naming View -->
        <div id="batch-naming-view" style="display:none;">
            <h3>为表情包命名</h3>
            <div id="batch-sticker-preview-grid" class="sticker-grid" style="max-height: 40vh; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 15px;">
                <!-- Previews will be generated here -->
            </div>
            <div class="form-group">
                <label for="batch-sticker-names-input">输入名称 (英文逗号隔开)</label>
                <textarea id="batch-sticker-names-input" rows="4" placeholder="开心,难过,你好,..."></textarea>
                 <p style="font-size: 12px; color: #888; margin-top: 5px;">提示：名称数量少于图片时，将自动补充默认名称。</p>
            </div>
            <div style="display:flex; gap: 10px; margin-top: 20px;">
                 <button class="btn btn-neutral" id="back-to-batch-upload-btn" style="flex:1;">返回上一步</button>
                 <button class="btn btn-primary" id="save-batch-stickers-btn" style="flex:1;">全部保存</button>
            </div>
        </div>
    </div>
</div>

<!-- END: 批量添加表情包弹窗 -->
	<!-- 文件位置: </body> 标签之前 -->
<input type="file" id="world-book-import-input" accept=".json" style="display: none;" multiple>
	<!-- =============================================================== -->
<!-- START: 新增商城功能HTML (粘贴到 </body> 标签前) -->
<!-- =============================================================== -->

<!-- 1. 商城主界面 -->
<div id="mall-screen" class="screen">
    <!-- 商城顶部 -->
    <header class="mall-header">
        <button class="back-btn" data-target="home-container">‹</button>
 <!-- ... 在 <header class="mall-header"> 内部 ... -->
<div class="search-bar-container">
    <svg id="mall-search-btn" class="search-icon" viewBox="0 0 24 24" style="cursor: pointer;"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L21.5,20L20,21.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
    <input type="text" id="mall-search-input" placeholder="万能杂货铺，搜搜看？">
</div>
<!-- ... -->
        <!-- 【新增】刷新按钮 -->
    <button class="action-btn" id="refresh-mall-btn" style="margin-left: 8px;">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M17.65,6.35C16.2,4.9, 14.21,4, 12,4A8,8, 0, 0,0, 4,12A8,8, 0, 0,0, 12,20C15.73,20, 18.84,17.45, 19.73,14H17.65C16.83,16.33, 14.61,18, 12,18A6,6, 0, 0,1, 6,12A6,6, 0, 0,1, 12,6C13.66,6, 15.14,6.69, 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
</button>
    </header>

    <!-- 商城主内容 -->
    <main class="content">
        <!-- 分类图标区域 -->
        <!-- 替换旧的 mall-categories div -->
<div class="mall-categories">
    <div class="function-item" id="add-custom-product-btn" style="cursor: pointer;">
        <div class="icon-bg" style="background-color: #e3f2fd;">
            <svg viewBox="0 0 24 24" fill="#1976d2"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
        </div>
        <span>个性商品</span>
    </div>
    <!-- 这里可以保留或添加其他分类图标 -->
            <!-- 这里可以动态生成或静态放置分类图标 -->
        </div>
        <!-- 商品网格 -->
        <div id="product-grid" class="product-grid">
            <!-- 商品卡片将由JS动态生成 -->
        </div>
        <!-- 【新增】加载更多指示器 -->
<div id="load-more-indicator" class="load-more-indicator">加载中...</div>
    </main>

    <!-- 商城底部导航 -->
    <nav class="mall-bottom-nav">
        <button class="nav-item active" data-target="mall-screen">
            <svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg>
            <span>首页</span>
        </button>
      <!-- ▼▼▼ 用下面这个“购物车”按钮替换它 ▼▼▼ -->
<button class="nav-item" data-target="mall-cart-screen">
    <svg viewBox="0 0 24 24"><path d="M17,18A2,2 0 0,1 19,20A2,2 0 0,1 17,22A2,2 0 0,1 15,20A2,2 0 0,1 17,18M7,18A2,2 0 0,1 9,20A2,2 0 0,1 7,22A2,2 0 0,1 5,20A2,2 0 0,1 7,18M7.17,14.75L7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.59 17.3,11.97L20.88,5.5H18.31L17.15,7.55L14.4,12H8.53L8.4,11.73L6,4H4V6H6L9.6,13.59L8.16,15.95C7.79,16.58 8.27,17.31 9,17.31H18V15.31H9.42L10.2,14Z" /></svg>
    <span>购物车</span>
</button>
        <button class="nav-item" data-target="mall-profile-screen">
            <svg viewBox="0 0 24 24"><path d="M12,12c2.21,0 4,-1.79 4,-4s-1.79,-4 -4,-4 -4,1.79 -4,4 1.79,4 4,4zm0,2c-2.67,0 -8,1.34 -8,4v2h16v-2c0,-2.66 -5.33,-4 -8,-4z"/></svg>
            <span>个人中心</span>
        </button>
        <button class="nav-item" data-target="mall-settings-screen">
            <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            <span>设置</span>
        </button>
    </nav>
</div>

<!-- 2. 个人中心页面 (修正版) -->
<div id="mall-profile-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container"><h1 class="title">个人中心</h1></div>
        <div class="placeholder"></div> <!-- 用于平衡布局 -->
    </header>
    <main class="content" style="padding: 10px 10px 80px 10px; background-color: #f5f5f5;">
        <!-- 个人信息头部 -->
        <div class="profile-header">
            <img id="profile-avatar" src="https://i.postimg.cc/GtbTnxhP/o-o-1.jpg" alt="avatar" class="profile-avatar">
            <h2 id="profile-username" class="profile-username">我的昵称</h2>
        </div>
<div class="profile-section" id="logistics-entry-section">
        <div class="wallet-action-item" data-target="logistics-screen">
            <span>我的物流</span>
            <span>›</span>
        </div>
    </div>
        <!-- 点赞记录 -->
        <div class="liked-products-section profile-section">
            <h3 class="section-title">我的点赞</h3>
            <div id="liked-products-grid" class="product-grid">
                <!-- 点赞的商品将由JS动态生成 -->
            </div>
            <p class="placeholder-text" id="no-liked-products" style="display: none;">还没有点赞过任何商品哦</p>
        </div>

        <!-- 付款记录 -->
        <div class="payment-history-section profile-section">
            <h3 class="section-title">付款记录</h3>
            <div id="payment-history-list">
                <!-- 付款记录将由JS动态生成 -->
            </div>
        </div>
    </main>
    <nav class="mall-bottom-nav">
        <button class="nav-item" data-target="mall-screen">
            <svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"></path></svg>
            <span>首页</span>
        </button>
        <button class="nav-item" data-target="mall-cart-screen">
            <svg viewBox="0 0 24 24"><path d="M17,18A2,2 0 0,1 19,20A2,2 0 0,1 17,22A2,2 0 0,1 15,20A2,2 0 0,1 17,18M7,18A2,2 0 0,1 9,20A2,2 0 0,1 7,22A2,2 0 0,1 5,20A2,2 0 0,1 7,18M7.17,14.75L7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.59 17.3,11.97L20.88,5.5H18.31L17.15,7.55L14.4,12H8.53L8.4,11.73L6,4H4V6H6L9.6,13.59L8.16,15.95C7.79,16.58 8.27,17.31 9,17.31H18V15.31H9.42L10.2,14Z"></path></svg>
            <span>购物车</span>
        </button>
        <button class="nav-item active" data-target="mall-profile-screen">
            <svg viewBox="0 0 24 24"><path d="M12,12c2.21,0 4,-1.79 4,-4s-1.79,-4 -4,-4 -4,1.79 -4,4 1.79,4 4,4zm0,2c-2.67,0 -8,1.34 -8,4v2h16v-2c0,-2.66 -5.33,-4 -8,-4z"/></svg>
            <span>个人中心</span>
        </button>
        <button class="nav-item" data-target="mall-settings-screen">
            <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            <span>设置</span>
        </button>
    </nav>
</div>
<!-- 3. 设置页面 -->
	<!-- 3. 设置页面 -->
<div id="mall-settings-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container"><h1 class="title">商城设置</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
    	<!-- ... 在 <form id="mall-api-form"> 内部 ... -->

<div class="form-group" style="display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
    <label for="special-items-toggle" style="margin-bottom: 0;">启用特殊商品模式</label>
    <input type="checkbox" id="special-items-toggle" style="width: auto; height: 20px;">
</div>

<!-- ... 就在 </form> 标签之前 ... -->
        <form id="mall-api-form" style="padding: 15px;">
            <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                此处API设置专用于商城模块。若留空，将自动使用主“API”应用中的设置。
            </p>
            <div class="form-group">
                <label for="mall-api-url">API 地址</label>
                <input type="url" id="mall-api-url" name="url" placeholder="例如：https://api.deepseek.com">
            </div>
            <div class="form-group">
                <label for="mall-api-key">密钥 (Key)</label>
                <input type="password" id="mall-api-key" name="key" placeholder="请输入商城的API密钥">
            </div>
            <button type="button" class="btn btn-secondary" id="mall-fetch-models-btn">
                <span class="btn-text">拉取模型</span>
                <div class="spinner"></div>
            </button>
            <div class="form-group">
                <label for="mall-api-model">选择模型</label>
                <select id="mall-api-model" name="model">
                    <option value="">请先拉取模型列表</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">保存商城API设置</button>
        </form>
    </main>
    <nav class="mall-bottom-nav">
        <button class="nav-item" data-target="mall-screen">
            <svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"></path></svg>
            <span>首页</span>
        </button>
        <button class="nav-item" data-target="mall-cart-screen">
            <svg viewBox="0 0 24 24"><path d="M17,18A2,2 0 0,1 19,20A2,2 0 0,1 17,22A2,2 0 0,1 15,20A2,2 0 0,1 17,18M7,18A2,2 0 0,1 9,20A2,2 0 0,1 7,22A2,2 0 0,1 5,20A2,2 0 0,1 7,18M7.17,14.75L7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.59 17.3,11.97L20.88,5.5H18.31L17.15,7.55L14.4,12H8.53L8.4,11.73L6,4H4V6H6L9.6,13.59L8.16,15.95C7.79,16.58 8.27,17.31 9,17.31H18V15.31H9.42L10.2,14Z"></path></svg>
            <span>购物车</span>
        </button>
        <button class="nav-item" data-target="mall-profile-screen">
            <svg viewBox="0 0 24 24"><path d="M12,12c2.21,0 4,-1.79 4,-4s-1.79,-4 -4,-4 -4,1.79 -4,4 1.79,4 4,4zm0,2c-2.67,0 -8,1.34 -8,4v2h16v-2c0,-2.66 -5.33,-4 -8,-4z"></path></svg>
            <span>个人中心</span>
        </button>
        <button class="nav-item active" data-target="mall-settings-screen">
            <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
            <span>设置</span>
        </button>
    </nav>
</div>

<!-- =============================================================== -->
<!-- END: 新增商城功能HTML -->
<!-- =============================================================== -->

  <!-- =============================================================== -->
<!-- START: 更新后的商品详情页面 (粘贴到 </body> 标签前) -->
<!-- =============================================================== -->
<div id="product-detail-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="mall-screen">‹</button>
        <div class="title-container"><h1 class="title">商品详情</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <div class="product-detail-card">
            <img id="detail-product-image" src="" alt="商品图片" class="detail-product-image">
            <div class="detail-product-info">
                <div class="detail-price-row">
                    <span id="detail-product-price" class="detail-product-price">¥0.00</span>
                    <div class="detail-stats">
                        <span id="detail-product-likes">❤️ 0</span>
                        <span id="detail-product-saves">⭐ 0</span>
                    </div>
                </div>
                <h2 id="detail-product-title" class="detail-product-title">商品名称加载中...</h2>
                <p id="detail-product-description" class="detail-product-description"></p>
            </div>
            <div id="detail-store-info" class="detail-store-info">
                <img id="detail-store-avatar" src="https://i.postimg.cc/VL1g9G5V/store-avatar.png" class="store-avatar">
                <span id="detail-store-name">店铺名称</span>
            </div>
            <div id="comment-section" class="comment-section">
                <h3>宝贝评价</h3>
                <ul id="comment-list"></ul>
                <button id="load-more-comments-btn" class="btn btn-neutral">加载更多评价</button>
            </div>
        </div>
    </main>
    <!-- 底部操作栏 -->
    <nav id="detail-footer-nav" class="detail-footer-nav">
        <button class="action-btn" id="like-product-btn">收藏</button>
        <button class="action-btn" id="pay-for-me-btn">找人代付</button>
        <button class="action-btn">加入购物车</button>
        <button class="action-btn primary">立即购买</button>
    </nav>
</div>

<!-- 1. 购物车页面 -->
<!-- ▼▼▼ 请用这个完整的代码块，替换掉您文件中旧的 id="mall-cart-screen" 的 div ▼▼▼ -->
<div id="mall-cart-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="mall-screen">‹</button>
        <div class="title-container"><h1 class="title">购物车</h1></div>
        <!-- 新增的管理/完成按钮 -->
        <div class="action-btn-group">
            <button class="action-btn" id="cart-manage-btn">管理</button>
        </div>
    </header>
    <main class="content" id="cart-item-list-container" style="padding: 10px 0;">
        <!-- 购物车商品将由JS动态生成 -->
    </main>
    
    <!-- 【新增】购物车结算栏 -->
    <div id="cart-checkout-bar" class="cart-checkout-bar">
        <div class="select-all-container">
            <div class="cart-item-selector" id="cart-select-all-btn"></div>
            <span>全选</span>
        </div>
        <div class="checkout-info">
            <span id="cart-total-price">合计: ¥0.00</span>
            <button class="btn btn-primary" id="cart-checkout-btn">去结算 (0)</button>
        </div>
 <!-- 新增的删除按钮，默认隐藏 -->
    <button class="btn btn-danger" id="cart-delete-selected-btn">删除</button>
</div>
    <nav class="mall-bottom-nav">
        <button class="nav-item" data-target="mall-screen"><span>首页</span></button>
        <button class="nav-item active" data-target="mall-cart-screen"><span>购物车</span></button>
        <button class="nav-item" data-target="mall-profile-screen"><span>个人中心</span></button>
        <button class="nav-item" data-target="mall-settings-screen"><span>设置</span></button>
    </nav>
</div>

<!-- 2. 购买流程主弹窗 (类似拼多多) -->
<div id="purchase-modal" class="modal-overlay">
    <div class="modal-window purchase-flow-modal">
        <button class="close-purchase-modal-btn">&times;</button>
        <div class="purchase-product-info">
            <img id="purchase-product-image" src="" alt="商品图片">
            <div>
                <p id="purchase-product-price">¥0.00</p>
                <h4 id="purchase-product-name">商品名称</h4>
            </div>
        </div>
        <div class="purchase-section">
            <h5>选择收货人 (代付/送礼)</h5>
            <ul id="recipient-selection-list" class="list-container">
                <!-- 收货人列表将由JS动态生成 -->
            </ul>
        </div>
        <button id="confirm-recipient-btn" class="btn btn-primary">确定</button>
    </div>
</div>

<!-- 3. 商品样式/数量选择弹窗 -->
<div id="product-options-modal" class="modal-overlay">
    <div class="modal-window purchase-flow-modal">
        <button class="close-purchase-modal-btn">&times;</button>
        <div class="purchase-product-info">
            <img id="options-product-image" src="" alt="商品图片">
            <div>
                <p id="options-product-price">¥0.00</p>
                <h4 id="options-product-name">商品名称</h4>
            </div>
        </div>
        <div class="purchase-section">
            <h5>选择样式</h5>
            <div id="style-options-container" class="style-options">
                <button class="style-option-btn active">默认款式</button>
                <!-- 更多款式可由JS添加 -->
            </div>
        </div>
        <div class="purchase-section quantity-section">
            <h5>购买数量</h5>
            <div class="quantity-selector">
                <button class="quantity-btn" id="decrease-quantity-btn">-</button>
                <input type="number" id="purchase-quantity-input" value="1" min="1">
                <button class="quantity-btn" id="increase-quantity-btn">+</button>
            </div>
        </div>
        <button id="confirm-purchase-btn" class="btn btn-primary">确定</button>
    </div>
</div>

<!-- 4. 自定义倒计时时长弹窗 -->
<div id="delivery-countdown-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>设置送达时间</h3>
        <p style="font-size: 13px; color: #666; text-align: center;">AI将会在倒计时结束后收到物品</p>
        <div class="form-group">
            <label for="delivery-duration-input">倒计时时长 (分钟)</label>
            <input type="number" id="delivery-duration-input" value="5" min="1" placeholder="请输入分钟数">
        </div>
        <button id="confirm-delivery-time-btn" class="btn btn-primary">确认购买</button>
    </div>
</div>
    </main>
<!-- =============================================================== -->
<!-- START: 商城购物流程新增模块 -->
<!-- =============================================================== -->

<!-- ▼▼▼ 请用这个完整的代码块，替换掉您文件中旧的 id="mall-cart-screen" 的 div ▼▼▼ -->
<div id="mall-cart-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="mall-screen">‹</button>
        <div class="title-container"><h1 class="title">购物车</h1></div>
        <!-- 新增的管理/完成按钮 -->
        <div class="action-btn-group">
            <button class="action-btn" id="cart-manage-btn">管理</button>
        </div>
    </header>
    <main class="content" id="cart-item-list-container" style="padding: 10px 0;">
        <!-- 购物车商品将由JS动态生成 -->
    </main>
    
    <!-- 【新增】购物车结算栏 -->
    <div id="cart-checkout-bar" class="cart-checkout-bar">
        <div class="select-all-container">
            <div class="cart-item-selector" id="cart-select-all-btn"></div>
            <span>全选</span>
        </div>
        <div class="checkout-info">
            <span id="cart-total-price">合计: ¥0.00</span>
            <button class="btn btn-primary" id="cart-checkout-btn">去结算 (0)</button>
        </div>
    <!-- 新增的删除按钮，默认隐藏 -->
    <button class="btn btn-danger" id="cart-delete-selected-btn" style="display: none;">删除</button>
</div>
    <nav class="mall-bottom-nav">
        <button class="nav-item" data-target="mall-screen"><span>首页</span></button>
        <button class="nav-item active" data-target="mall-cart-screen"><span>购物车</span></button>
        <button class="nav-item" data-target="mall-profile-screen"><span>个人中心</span></button>
        <button class="nav-item" data-target="mall-settings-screen"><span>设置</span></button>
    </nav><!-- 【新增】收藏商品的选择结算栏 -->
<div id="likes-checkout-bar" class="likes-checkout-bar">
    <span id="likes-total-price">总计: ¥0.00</span>
    <div>
        <button class="btn btn-neutral btn-small" id="cancel-likes-selection-btn">取消</button>
        <button class="btn btn-primary btn-small" id="checkout-likes-btn">结算</button>
    </div>
</div>
</div>

<!-- 2. 购买流程主弹窗 (类似拼多多) -->
<div id="purchase-modal" class="modal-overlay">
    <div class="modal-window purchase-flow-modal">
        <button class="close-purchase-modal-btn">&times;</button>
        <div class="purchase-product-info">
            <img id="purchase-product-image" src="" alt="商品图片">
            <div>
                <p id="purchase-product-price">¥0.00</p>
                <h4 id="purchase-product-name">商品名称</h4>
            </div>
        </div>
        <div class="purchase-section">
            <h5>选择收货人</h5>
            <ul id="recipient-selection-list" class="list-container">
                <!-- 收货人列表将由JS动态生成 -->
            </ul>
        </div>
        <button id="confirm-recipient-btn" class="btn btn-primary">确定</button>
    </div>
</div>

<!-- 3. 商品样式/数量选择弹窗 -->
<div id="product-options-modal" class="modal-overlay">
    <div class="modal-window purchase-flow-modal">
        <button class="close-purchase-modal-btn">&times;</button>
        <div class="purchase-product-info">
            <img id="options-product-image" src="" alt="商品图片">
            <div>
                <p id="options-product-price">¥0.00</p>
                <h4 id="options-product-name">商品名称</h4>
            </div>
        </div>
        <div class="purchase-section">
            <h5>选择样式</h5>
            <div id="style-options-container" class="style-options">
                <button class="style-option-btn active">默认款式</button>
                <!-- 更多款式可由JS添加 -->
            </div>
        </div>
        <div class="purchase-section quantity-section">
            <h5>购买数量</h5>
            <div class="quantity-selector">
                <button class="quantity-btn" id="decrease-quantity-btn">-</button>
                <input type="number" id="purchase-quantity-input" value="1" min="1">
                <button class="quantity-btn" id="increase-quantity-btn">+</button>
            </div>
        </div>
        <button id="confirm-purchase-btn" class="btn btn-primary">确定</button>
    </div>
</div>

<!-- 4. 自定义倒计时时长弹窗 -->
<div id="delivery-countdown-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>设置送达时间</h3>
        <div class="form-group">
            <label for="delivery-duration-input">倒计时时长 (分钟)</label>
            <input type="number" id="delivery-duration-input" value="5" min="1" placeholder="请输入分钟数">
        </div>
        <button id="confirm-delivery-time-btn" class="btn btn-primary">确认购买</button>
    </div>
</div>

<!-- =============================================================== -->
<!-- END: 商城购物流程新增模块 -->
<!-- =============================================================== -->
	<!-- =============================================================== -->
<!-- START: 新增AI空间手机界面 (粘贴到 </body> 标签前) -->
<!-- =============================================================== -->

<!-- 1. AI空间主屏幕 (手机桌面) -->
<div id="ai-space-home-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container">
            <h1 class="title">AI的手机</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content" style="background: #f5f5f5; padding: 20px;">
        <div id="ai-space-app-grid" class="app-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px;">
            <!-- App icons will be generated by JS -->
        </div>
    </main>
</div>

<!-- 2. AI空间内的通用 "AI选择列表" 页面 -->
<div id="ai-space-character-select-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-space-home-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="ai-space-select-title">选择AI</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <ul class="list-container" id="ai-space-select-list"></ul>
    </main>
</div>

<!-- =============================================================== -->
<!-- START: 新增 Peek 手机功能界面 (移植自 reference_UwU.html) -->
<!-- =============================================================== -->

<!-- Peek 消息列表 -->
<div id="peek-messages-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-space-home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">Ta的消息</h1>
        </div>
        <button class="action-btn" id="refresh-peek-messages-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
        </button>
    </header>
    <main class="content">
        <ul class="list-container" id="peek-chat-list-container">
            <!-- Simulated chat list will be rendered here -->
        </ul>
    </main>
</div>

<!-- Peek 对话详情 -->
<div id="peek-conversation-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="peek-messages-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="peek-conversation-title">...</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <div class="message-area" id="peek-message-area">
            <!-- Conversation will be rendered here -->
        </div>
        <div class="input-area">
            <div class="fake-input"></div>
            <button class="plus-btn"></button>
        </div>
    </main>
</div>

<!-- Peek 备忘录列表 -->
<div id="peek-memos-screen" class="screen">
    <!-- Rendered by renderMemosList() -->
</div>

<!-- Peek 备忘录详情 -->
<div id="peek-memo-detail-screen" class="screen">
    <!-- Rendered by renderMemoDetail() -->
</div>

<!-- Peek 购物车 -->
<div id="peek-cart-screen" class="screen">
    <!-- Rendered by renderPeekCart() -->
</div>

<!-- Peek 中转站 -->
<div id="peek-transfer-station-screen" class="screen">
    <!-- Rendered by renderPeekTransferStation() -->
</div>

<!-- Peek 浏览器 -->
<div id="peek-browser-screen" class="screen">
    <!-- Rendered by renderPeekBrowser() -->
</div>

<!-- Peek 相册 -->
<div id="peek-album-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-space-home-screen">‹</button>
        <div class="title-container"><h1 class="title">相册</h1></div>
        <button class="action-btn" id="refresh-album-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
    </header>
    <main class="content">
        <div class="album-grid">
            <p class="placeholder-text">正在生成相册内容...</p>
        </div>
    </main>
</div>

<!-- Peek 相册照片详情模态框 -->
<div id="peek-photo-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 90%; max-height: 85vh; overflow-y: auto;">
        <div id="peek-photo-image-container" style="width: 100%; height: 300px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; border-radius: 8px;">
            <!-- Image description will be shown here -->
        </div>
        <p id="peek-photo-description" style="color: #666; font-size: 14px; line-height: 1.6;"></p>
        <button class="btn btn-primary" id="close-peek-photo-btn" style="margin-top: 20px;">关闭</button>
    </div>
</div>

<!-- Peek Unlock (微博小号) -->
<div id="peek-unlock-screen" class="screen">
    <!-- Rendered by renderPeekUnlock() -->
</div>

<!-- =============================================================== -->
<!-- END: 新增 Peek 手机功能界面 -->
<!-- =============================================================== -->
	<!-- =============================================================== -->
<!-- START: 新增商城支付与物流模块 -->
<!-- =============================================================== -->

<!-- ▼▼▼ 用这个新版本，完整替换旧的 id="payment-confirmation-screen" <div> ▼▼▼ -->
<div id="payment-confirmation-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="mall-cart-screen">‹</button>
        <div class="title-container"><h1 class="title">确认付款</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content" style="background-color: #f5f5f5; padding: 10px;">
        <!-- 新增：收货人选择 -->
        <div class="payment-section recipient-selector-section">
            <h5>收货人</h5>
            <select id="payment-recipient-select" class="form-group" style="width: 100%; margin: 0;"></select>
        </div>
        
        <!-- 商品列表 -->
        <div id="payment-items-list" class="payment-section">
            <!-- 商品将由JS动态生成 -->
        </div>

        <!-- 新增：自定义送达时间 -->
        <div class="payment-section delivery-time-section">
            <h5>预计送达时间 (分钟后)</h5>
            <input type="number" id="payment-delivery-duration" class="form-group" value="5" min="1" style="width: 100%; margin: 0;">
        </div>

        <!-- 支付方式 -->
        <div class="payment-section payment-methods">
            <div class="method-item" id="pay-for-me-btn"><img src="https://i.postimg.cc/TPgT7rGF/friend-pay.png"> 找404成员代付</div>
            <div class="method-item selected"><img src="https://i.postimg.cc/SKvL5dMy/wallet.png"> 零钱支付</div>
        </div>
    </main>
    <!-- 底部支付栏 -->
    <footer class="payment-footer">
        <div class="price-details">
            合计: <span class="total-price" id="payment-total-price">¥0.00</span>
        </div>
        <button class="btn btn-primary" id="confirm-final-payment-btn">确认支付</button>
    </footer>
</div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->
<!-- ▲▲▲ 替换结束 ▲▲▲ -->
<div id="persona-presets-modal" class="modal-overlay" style="display:none;">
    <div class="modal-window" style="max-width:520px;">
        <h3 style="margin:0 0 10px 0;">管理人设预设</h3>
        <div id="persona-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="persona-close-modal" class="btn btn-primary" style="padding:8px 12px;">关闭</button>
        </div>
    </div>
</div>
<!-- ▼▼▼ 将这两个全新的 div 添加到 </body> 标签之前 ▼▼▼ -->

<!-- 1. "找人代付" AI选择弹窗 -->
<div id="pay-for-me-select-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>选择代付好友</h3>
        <ul id="pay-for-me-selection-list" class="list-container" style="max-height: 50vh; overflow-y: auto;">
            <!-- AI列表将由JS动态生成 -->
        </ul>
        <button class="btn btn-neutral" id="cancel-pay-for-me-btn" style="margin-top: 15px;">取消</button>
    </div>
</div>

<!-- 2. 物流追踪页面 -->
<div id="logistics-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="mall-profile-screen">‹</button>
        <div class="title-container"><h1 class="title">我的物流</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content" style="padding: 10px; background-color: #f5f5f5;">
        <div id="logistics-list-container">
            <!-- 物流信息将由JS动态生成 -->
        </div>
        <p class="placeholder-text" id="no-logistics-placeholder" style="display: none;">暂无物流信息</p>
    </main>
</div>
<!-- ▲▲▲ 添加结束 ▲▲▲ -->

<!-- =============================================================== -->
<!-- START: 新增自定义商品创建弹窗 -->
<!-- =============================================================== -->
<div id="create-product-modal" class="modal-overlay">
    <div class="modal-window" style="max-height: 85vh; display: flex; flex-direction: column;">
        <h3>创建个性商品</h3>
        <form id="create-product-form" style="overflow-y: auto; flex-grow: 1; padding: 5px;">
            <div class="form-group">
                <label for="custom-product-image-url">商品图片 URL</label>
                <input type="url" id="custom-product-image-url" placeholder="粘贴图片链接...">
            </div>
            <div class="form-group">
                <label for="custom-product-name">商品名称</label>
                <input type="text" id="custom-product-name" required>
            </div>
            <div class="form-group">
                <label for="custom-product-price">商品价格</label>
                <input type="number" id="custom-product-price" required step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="custom-product-store">店铺名称</label>
                <input type="text" id="custom-product-store" value="我的小店" required>
            </div>
            <div class="form-group">
                <label for="custom-product-description">商品描述 (普通商品)</label>
                <textarea id="custom-product-description" rows="3"></textarea>
            </div>
            <hr style="border:none; border-top: 1px solid #eee; margin: 15px 0;">
            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                <label for="is-special-product-toggle" style="margin-bottom: 0;">是否为特殊商品？</label>
                <input type="checkbox" id="is-special-product-toggle" style="width: auto; height: 20px;">
            </div>

            <!-- 特殊商品字段，默认隐藏 -->
            <div id="special-product-fields" class="special-product-fields">
                <div class="form-group">
                    <label for="special-product-function">功能 (必须能在对话中体现)</label>
                    <input type="text" id="special-product-function" placeholder="例如：让收件人只能说真话">
                </div>
                <div class="form-group">
                    <label for="special-product-duration">效果持续 (轮对话)</label>
                    <input type="number" id="special-product-duration" min="1" placeholder="例如：5">
                </div>
                <div class="form-group">
                    <label for="special-product-side-effect">副作用 (可选)</label>
                    <input type="text" id="special-product-side-effect" placeholder="例如：效果结束后会头痛">
                </div>
                <div class="form-group">
                    <label for="special-product-side-effect-duration">副作用持续 (轮对话)</label>
                    <input type="number" id="special-product-side-effect-duration" min="1" placeholder="例如：3">
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">创建商品</button>
        </form>
    </div>
</div>
<!-- =============================================================== -->
<!-- END: 新增自定义商品创建弹窗 -->
<!-- =============================================================== -->
	<!-- =============================================================== -->
<!-- START: 新增AI空间应用界面 (心动讯号, 购物, 备忘录) -->
<!-- =============================================================== -->

<!-- 1. 心动讯号 - 结果显示页面 -->
<div id="ai-space-signal-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-space-character-select-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="ai-signal-title">的心动讯号</h1>
        </div>
        <button class="action-btn" id="refresh-signal-btn">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M17.65,6.35C16.2,4.9, 14.21,4, 12,4A8,8, 0, 0,0, 4,12A8,8, 0, 0,0, 12,20C15.73,20, 18.84,17.45, 19.73,14H17.65C16.83,16.33, 14.61,18, 12,18A6,6, 0, 0,1, 6,12A6,6, 0, 0,1, 12,6C13.66,6, 15.14,6.69, 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
        </button>
    </header>
    <main class="content" style="padding: 20px; line-height: 1.8;">
        <div id="ai-signal-content">
            <p class="placeholder-text">点击右上角按钮，生成心动瞬间</p>
        </div>
    </main>
</div>

<!-- 2. 购物 - 记录列表页面 -->
<div id="ai-space-shopping-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-space-character-select-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="ai-shopping-title">的购物记录</h1>
        </div>
        <button class="action-btn" id="refresh-shopping-btn">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M17.65,6.35C16.2,4.9, 14.21,4, 12,4A8,8, 0, 0,0, 4,12A8,8, 0, 0,0, 12,20C15.73,20, 18.84,17.45, 19.73,14H17.65C16.83,16.33, 14.61,18, 12,18A6,6, 0, 0,1, 6,12A6,6, 0, 0,1, 12,6C13.66,6, 15.14,6.69, 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
        </button>
    </header>
    <main class="content">
        <ul class="list-container" id="ai-shopping-list">
            <p class="placeholder-text">点击右上角按钮，生成购物记录</p>
        </ul>
    </main>
</div>

<!-- 3. 备忘录 - 记录列表页面 -->
<div id="ai-space-memo-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-space-character-select-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="ai-memo-title">的备忘录</h1>
        </div>
        <button class="action-btn" id="refresh-memo-btn">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M17.65,6.35C16.2,4.9, 14.21,4, 12,4A8,8, 0, 0,0, 4,12A8,8, 0, 0,0, 12,20C15.73,20, 18.84,17.45, 19.73,14H17.65C16.83,16.33, 14.61,18, 12,18A6,6, 0, 0,1, 6,12A6,6, 0, 0,1, 12,6C13.66,6, 15.14,6.69, 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
        </button>
    </header>
    <main class="content">
        <ul class="list-container" id="ai-memo-list">
             <p class="placeholder-text">点击右上角按钮，生成备忘录</p>
        </ul>
    </main>
</div>

<!-- =============================================================== -->
<!-- END: 新增AI空间应用界面 -->
<!-- =============================================================== -->
	<!-- =============================================================== -->
<!-- START: 新增AI空间 - 音乐App界面 -->
<!-- =============================================================== -->
<div id="ai-space-music-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="ai-space-character-select-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="ai-music-playlist-title">的歌单</h1>
        </div>
        <button class="action-btn" id="refresh-music-playlist-btn">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M17.65,6.35C16.2,4.9, 14.21,4, 12,4A8,8, 0, 0,0, 4,12A8,8, 0, 0,0, 12,20C15.73,20, 18.84,17.45, 19.73,14H17.65C16.83,16.33, 14.61,18, 12,18A6,6, 0, 0,1, 6,12A6,6, 0, 0,1, 12,6C13.66,6, 15.14,6.69, 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
        </button>
    </header>
    <main class="content">
        <ul class="list-container" id="ai-music-playlist-list">
             <p class="placeholder-text">点击右上角按钮，生成歌单</p>
        </ul>
    </main>
</div>
<!-- =============================================================== -->
<!-- END: 新增AI空间 - 音乐App界面 -->
<!-- =============================================================== -->
	
	<!-- =============================================================== -->
<!-- START: 新增“心灵羁绊”App界面 -->
<!-- =============================================================== -->
<!-- =============================================================== -->
<!-- START: [已更新V3.0] 心灵羁绊App界面 (粉色主题) -->
<!-- =============================================================== -->
<div id="soul-bond-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-container">‹</button>
        <div class="title-container">
            <h1 class="title">心灵羁绊</h1>
        </div>
        <!-- 核心修改：设置按钮图标改为爱心，并添加切换按钮 -->
        <div class="action-btn-group">
            <button class="action-btn" id="bond-switch-btn" title="切换/添加伴侣">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:22px; height:22px;">
                    <path d="M17 3l4 4-4 4M21 7H7m10 10l-4 4-4-4M3 17h14"></path>
                </svg>
            </button>
            <button class="action-btn" id="bond-settings-btn">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path></svg>
            </button>
        </div>
    </header>
    <main class="content">
        <!-- 顶部照片滚动区 -->
        <div class="bond-photo-scroll-container">
            <div class="bond-photo-scroll" id="bond-photo-scroll">
                <!-- 拍立得照片将由JS动态生成 -->
            </div>
        </div>

        <!-- 核心修改：恢复旧版大卡片布局 -->
        <div class="bond-main-card">
            <div class="bond-anniversary">
                <p>距离下一个纪念日还有</p>
                <h2 id="bond-countdown-days">...</h2>
                <span>天</span>
            </div>
            <div class="bond-avatars">
                <div class="bond-avatar-container">
                    <img id="bond-my-avatar" src="">
                    <span id="bond-my-name">...</span>
                </div>
                <svg class="bond-heart" viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z" /></svg>
                <div class="bond-avatar-container">
                    <img id="bond-ai-avatar" src="">
                    <span id="bond-ai-name">...</span>
                </div>
            </div>
            <div class="bond-days-counter">我们已经在一起 <strong id="bond-total-days">...</strong> 天</div>
        </div>
        
    </main>

    <!-- 底部功能导航栏 -->
    <footer class="bond-bottom-nav">
        <button class="bond-nav-btn" data-feature="wishlist" title="愿望清单"><svg viewBox="0 0 24 24"><path d="M19.5,5.5V18.5H4.5V5.5H19.5M19.5,3.5H4.5C3.4,3.5 2.5,4.4 2.5,5.5V18.5C2.5,19.6 3.4,20.5 4.5,20.5H19.5C20.6,20.5 21.5,19.6 21.5,18.5V5.5C21.5,4.4 20.6,3.5 19.5,3.5M15.5,16.5H6.5V14.5H15.5V16.5M17.5,12.5H6.5V10.5H17.5V12.5M17.5,8.5H6.5V6.5H17.5V8.5Z"/></svg></button>
        <button class="bond-nav-btn" data-feature="diary" title="交换日记"><svg viewBox="0 0 24 24"><path d="M14,10V4.5L19.5,10M5,3C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V9L15,3H5Z"/></svg></button>
        <button class="bond-nav-btn" data-feature="pomodoro" title="专注模式"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M16.24,7.76L12,12V7H11V13H17V12H12.24L16.24,7.76Z"/></svg></button>
        <button class="bond-nav-btn" data-feature="dailyquestion" title="每日一问"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6M11,17H13V19H11V17Z"/></svg></button>
        <button class="bond-nav-btn" data-feature="mood" title="情绪天气"><svg viewBox="0 0 24 24"><path d="M17.6,14.04C18.4,13.24 18.9,12.16 19,11C19.1,9.8 18.6,8.68 17.8,7.88C17,7.07 15.9,6.6 14.7,6.58C13.5,6.56 12.3,6.93 11.4,7.63C10.5,8.34 9.89,9.3 9.73,10.42C9.57,11.54 9.86,12.7 10.5,13.68L12,15.29L13.41,16.7L17.6,14.04M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.58,20 4,16.42 4,12C4,7.58 7.58,4 12,4C16.42,4 20,7.58 20,12C20,16.42 16.42,20 12,20Z"/></svg></button>
    </footer>
</div>
<!-- =============================================================== -->
<!-- END: "心灵羁绊"App界面 -->
<!-- =============================================================== -->
<!-- =============================================================== -->
<!-- START: 缺失的“心灵羁绊”与“渲染器”功能模块 (修复报错) -->
<!-- =============================================================== -->

<!-- 1. “心灵羁绊”App的设置弹窗 -->
<div id="bond-settings-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>羁绊设置</h3>
        <form id="bond-settings-form">
            <div class="form-group">
                <label for="bond-my-name-input">我的昵称</label>
                <input type="text" id="bond-my-name-input">
            </div>
            <div class="form-group">
                <label for="bond-ai-name-input">Ta的昵称</label>
                <input type="text" id="bond-ai-name-input">
            </div>
         <!-- ▼▼▼ 用这个代码块替换旧的纪念日设置部分 ▼▼▼ -->
            <div class="form-group">
                <label for="bond-anniversary-date-input">纪念日日期</label>
                <input type="date" id="bond-anniversary-date-input">
            </div>
            <div class="form-group">
                <label for="bond-anniversary-desc-input">纪念日名称</label>
                <input type="text" id="bond-anniversary-desc-input" placeholder="例如：我们的相遇纪念日">
            </div>
            <!-- ▲▲▲ 替换结束 ▲▲▲ -->
            <div class="form-group">
                <label for="bond-background-url-input">背景图片 URL</label>
                <input type="url" id="bond-background-url-input" placeholder="留空则使用默认纯色背景">
            </div>
            <div class="form-group">
                <label for="add-bond-photo-btn">添加照片</label>
                 <button type="button" class="btn btn-secondary" id="add-bond-photo-btn">添加回忆照片</button>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 15px;">保存设置</button>
        </form>
    </div>
</div>

<!-- 2. “渲染器”App缺失的分类弹窗 -->
<div id="renderer-category-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>创建新分类</h3>
        <form id="renderer-category-form">
            <div class="form-group">
                <label for="renderer-category-name">分类名称</label>
                <input type="text" id="renderer-category-name" placeholder="例如：通用效果、角色专属" required>
            </div>
            <button type="submit" class="btn btn-primary">创建</button>
        </form>
    </div>
</div>

<!-- 3. “渲染器”App缺失的隐藏文件输入框 -->
<input type="file" id="renderer-import-input" accept=".json" style="display: none;" multiple>

<!-- =============================================================== -->
<!-- END: 缺失模块 -->
<!-- =============================================================== -->
	<!-- =============================================================== -->
<!-- START: 新增“心灵羁绊”App的附属界面 -->
<!-- =============================================================== -->

<!-- 1. 愿望清单页面 -->
<div id="bond-wishlist-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="soul-bond-screen">‹</button>
        <div class="title-container">
            <h1 class="title">我们的愿望清单</h1>
        </div>
        <button class="action-btn" id="refresh-wishlist-btn">
             <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><path d="M17.65,6.35C16.2,4.9, 14.21,4, 12,4A8,8, 0, 0,0, 4,12A8,8, 0, 0,0, 12,20C15.73,20, 18.84,17.45, 19.73,14H17.65C16.83,16.33, 14.61,18, 12,18A6,6, 0, 0,1, 6,12A6,6, 0, 0,1, 12,6C13.66,6, 15.14,6.69, 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
        </button>
    </header>
    <main class="content">
        <ul class="list-container" id="bond-wishlist-container">
            <!-- 愿望清单将由JS动态生成 -->
        </ul>
    </main>
    <!-- 新增：愿望清单的浮动添加按钮 -->
<button class="new-post-btn" id="add-wish-fab" style="bottom: 20px;">+</button>
</div>

<!-- 2. 添加回忆照片的弹窗 -->
<div id="add-bond-photo-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>添加一张回忆照片</h3>
        <p style="font-size: 13px; color: #666; text-align: center;">AI将根据你们的聊天记录，生成一张有意义的照片回忆。</p>
        <div id="bond-photo-generation-spinner" style="display: none; text-align: center; margin: 20px 0;">
            <div class="spinner" style="display: inline-block; border-top-color: var(--primary-color); border-left-color: var(--primary-color);"></div>
            <p>正在生成中...</p>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-neutral" id="cancel-add-photo-btn" style="flex: 1;">取消</button>
            <button class="btn btn-primary" id="confirm-add-photo-btn" style="flex: 1;">确认生成</button>
        </div>
    </div>
</div>

<!-- =============================================================== -->
<!-- END: 新增“心灵羁绊”App的附属界面 -->
<!-- =============================================================== -->
	<!-- =============================================================== -->
<!-- START: 新增“心灵羁绊”App的附属界面 V2.0 -->
<!-- =============================================================== -->

<!-- 1. 自定义添加/编辑愿望的弹窗 -->
<div id="bond-wish-editor-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="wish-editor-title">添加一个新愿望</h3>
        <form id="bond-wish-form">
            <input type="hidden" id="editing-wish-id">
            <div class="form-group">
                <textarea id="wish-text-input" rows="4" required placeholder="写下想一起完成的事..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">保存愿望</button>
        </form>
    </div>
</div>

<!-- 2. 自定义上传回忆照片的弹窗 -->
<div id="add-custom-bond-photo-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>添加自定义回忆照片</h3>
        <form id="custom-bond-photo-form">
            <div class="form-group">
                <label for="custom-photo-upload" class="btn btn-secondary">选择图片</label>
                <input type="file" id="custom-photo-upload" accept="image/*" style="display:none;">
                <div id="custom-photo-preview" style="width: 100px; height: 100px; border: 1px dashed #ccc; margin: 10px auto; background-size: cover; background-position: center;"></div>
            </div>
            <div class="form-group">
                <label for="custom-photo-desc">写下照片背后的故事</label>
                <textarea id="custom-photo-desc" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">保存这张回忆</button>
        </form>
    </div>
</div>

<!-- =============================================================== -->
<!-- END: 新增附属界面 -->
<!-- =============================================================== -->
	<!-- =============================================================== -->
<!-- START: 新增“心灵羁绊”App的附属界面 V2.0 -->
<!-- =============================================================== -->

<!-- 1. 自定义添加/编辑愿望的弹窗 -->
<div id="bond-wish-editor-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="wish-editor-title">添加一个新愿望</h3>
        <form id="bond-wish-form">
            <input type="hidden" id="editing-wish-id">
            <div class="form-group">
                <textarea id="wish-text-input" rows="4" required placeholder="写下想一起完成的事..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">保存愿望</button>
        </form>
    </div>
</div>
<div id="miss-you-actionsheet" class="action-sheet-overlay">
    <div class="action-sheet">
        <button class="action-sheet-button" data-level="有点想你">有点想你...</button>
        <button class="action-sheet-button" data-level="非常想你">非常想你！</button>
        <button class="action-sheet-button danger" id="cancel-miss-you-btn">取消</button>
    </div>
</div>
<!-- END: 新增“想你啦”功能模块 -->
	<!-- =============================================================== -->
<!-- START: 心灵羁绊 - 番茄钟 V2.0 功能模块 -->
<!-- =============================================================== -->

<!-- =============================================================== -->
<!-- START: 心灵羁绊 - 番茄钟 V2.1 功能模块 (替换旧版) -->
<!-- =============================================================== -->

<!-- 1. 番茄钟主页面 -->
<div id="pomodoro-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="soul-bond-screen">‹</button>
        <div class="title-container">
            <h1 class="title">专注模式</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="pomodoro-history-btn" title="历史记录">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13,3A9,9 0 0,0 4,12H1L4.89,15.89L8.78,12H6A7,7 0 0,1 13,5V8L18,4L13,0V3M12,12A2,2 0 0,0 10,14A2,2 0 0,0 12,16A2,2 0 0,0 14,14A2,2 0 0,0 12,12M7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12Z"/></svg>
            </button>
            <button class="action-btn" id="pomodoro-open-settings-btn" title="设置">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.45,14.63L4.6,13.05C4.54,12.72 4.5,12.37 4.5,12C4.5,11.63 4.54,11.28 4.6,10.95L2.45,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.06C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.06L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.55,9.37L19.4,10.95C19.46,11.28 19.5,11.63 19.5,12C19.5,12.37 19.46,12.72 19.4,13.05L21.55,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.94C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10Z"/></svg>
            </button>
        </div>
    </header>
    <main class="content pomodoro-main-content">
        <div class="pomodoro-timer-card">
            <div id="pomodoro-main-time" class="pomodoro-time-display">25:00</div>
            <div class="pomodoro-task-bar">
                <span>当前任务:</span>
                <span id="pomodoro-task-name" contenteditable="true">英语作业</span>
            </div>
        </div>

        <div class="pomodoro-avatar-wrapper">
            <img id="pomodoro-ai-avatar" src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="AI Avatar">
        </div>

        <div class="pomodoro-ai-message">
            <div id="pomodoro-ai-status">爱德华发呆中 💭</div>
            <p id="pomodoro-ai-companion-text">准备好了吗？我们开始吧！</p>
        </div>

        <button id="pomodoro-start-btn" class="pomodoro-start-button">开始</button>
    </main>
</div>

<!-- 2. 番茄钟设置页面 -->
<div id="pomodoro-settings-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="pomodoro-screen">‹</button>
        <div class="title-container"><h1 class="title">专注设置</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <form id="pomodoro-settings-form-v2">
            <div class="form-group">
                <label for="pomodoro-wallpaper-input">背景图片 URL</label>
                <input type="url" id="pomodoro-wallpaper-input" placeholder="留空则使用默认纯色">
            </div>
            <div class="form-group">
                <label for="pomodoro-avatar-input">陪伴头像 URL</label>
                <input type="url" id="pomodoro-avatar-input" placeholder="粘贴图片链接">
            </div>
            <div class="form-group">
                <label for="pomodoro-sound-url-input">陪伴提示音 URL</label>
                <input type="url" id="pomodoro-sound-url-input" placeholder="点击头像时播放的声音">
            </div>
             <div class="form-group">
                <label for="pomodoro-card-wallpaper-input">计时卡片背景 URL</label>
                <input type="url" id="pomodoro-card-wallpaper-input" placeholder="可选，为卡片设置背景">
            </div>
            <hr>
            <div class="form-group">
                <label>默认计时模式</label>
                <div class="form-group radio-group">
                    <label><input type="radio" name="timer-mode" value="countdown" checked> 番茄钟 (倒计时)</label>
                    <label><input type="radio" name="timer-mode" value="stopwatch"> 正计时</label>
                </div>
            </div>
             <div class="form-group">
                <label for="focus-duration-input">专注时长 (分钟)</label>
                <input type="number" id="focus-duration-input" min="1" value="25">
            </div>
            <div class="form-group">
                <label for="short-break-duration-input">短休息时长 (分钟)</label>
                <input type="number" id="short-break-duration-input" min="1" value="5">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 15px;">保存设置</button>
        </form>
    </main>
</div>

<!-- 3. 专注历史记录页面 -->
<div id="pomodoro-history-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="pomodoro-screen">‹</button>
        <div class="title-container"><h1 class="title">专注记录</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <ul class="list-container" id="pomodoro-history-list"></ul>
        <p class="placeholder-text" id="no-pomodoro-history">还没有完成过专注任务哦。</p>
    </main>
</div>

<!-- 4. 提示音 -->
<audio id="pomodoro-alert-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-clear-announce-tones-2861.mp3" preload="auto"></audio>

<!-- =============================================================== -->
<!-- END: 心灵羁绊 - 番茄钟 V2.1 功能模块 -->
<!-- =============================================================== -->


<div id="font-presets-modal" class="modal-overlay" style="display:none;">
    <div class="modal-window" style="max-width:520px;">
        <h3 style="margin:0 0 10px 0;">管理字体预设</h3>
        <div id="font-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="font-close-modal" class="btn btn-primary" style="padding:8px 12px;">关闭</button>
        </div>
    </div>
</div>

<!-- Token 统计弹窗 -->
<div id="token-stats-modal" class="modal-overlay" style="display:none;">
    <div class="modal-window" style="max-width:520px;">
        <h3 style="margin:0 0 15px 0;">当前 Token 统计</h3>
        <div style="max-height:60vh; overflow-y:auto; margin-bottom:15px;">
            <!-- 分组 A: 静态估算 -->
            <div style="margin-bottom:20px; padding:15px; background:#f9f9f9; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:14px; color:#666; font-weight:600;">📊 静态估算 (当前上下文)</h4>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee;">
                    <span style="color:#333;">人设 (System):</span>
                    <span id="token-stats-system" style="font-weight:600; color:#4c9ffe;">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee;">
                    <span style="color:#333;">世界书 (World Info):</span>
                    <span id="token-stats-worldinfo" style="font-weight:600; color:#4c9ffe;">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee;">
                    <span style="color:#333;">上下文 (History):</span>
                    <span id="token-stats-history" style="font-weight:600; color:#4c9ffe;">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0;">
                    <span style="color:#333;">表情包 (Stickers):</span>
                    <span id="token-stats-stickers" style="font-weight:600; color:#4c9ffe;">0</span>
                </div>
            </div>
            
            <!-- 分组 B: 统计数据 -->
            <div style="margin-bottom:20px; padding:15px; background:#fff8f0; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:14px; color:#666; font-weight:600;">📈 统计数据</h4>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee;">
                    <span style="color:#333;">当前历史消息条数:</span>
                    <span id="token-stats-message-count" style="font-weight:600; color:#ff9800;">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0;">
                    <span style="color:#333;">上次 API 真实消耗:</span>
                    <span id="token-stats-last-usage" style="font-weight:600; color:#ff9800;">-</span>
                </div>
            </div>
            
            <!-- 总计估算 -->
            <div style="padding:15px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; text-align:center;">
                <div style="color:#fff; font-size:12px; margin-bottom:8px; opacity:0.9;">总计估算</div>
                <div id="token-stats-total" style="color:#fff; font-size:32px; font-weight:700;">0</div>
            </div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="token-stats-close-btn" class="btn btn-primary" style="padding:8px 12px;">关闭</button>
        </div>
    </div>
</div>
  
<script src="script.js"></script>

</body>

</html>